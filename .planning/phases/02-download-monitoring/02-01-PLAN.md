---
phase: 02-download-monitoring
plan: 01
type: execute
---

<objective>
Refine existing download monitor to fix critical bugs, add resilience for qBittorrent unavailability, and verify end-to-end monitoring works reliably.

Purpose: Ensure the automation bridge between torrent submission and file organization is robust and handles failures gracefully.
Output: Production-ready download monitoring with proper error handling, resilience, and verified functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-qbittorrent-integration/01-01-SUMMARY.md
@.planning/phases/01-qbittorrent-integration/01-02-SUMMARY.md
@.planning/phases/01.1-qbittorrent-connection-testing/01.1-01-SUMMARY.md
@.planning/phases/02-download-monitoring/02-CONTEXT.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md
@backend/internal/downloads/monitor.go
@backend/internal/qbittorrent/client.go
@backend/internal/qbittorrent/types.go

**Current State:**
- Monitor exists and is running (backend/internal/downloads/monitor.go)
- Already wired up in main.go (lines 68-78)
- GetTorrentStatus() method exists in qBittorrent client
- Repository has all needed methods (GetActive, UpdateStatus, UpdateProgress, UpdateCompleted)

**Known Issues (from CONCERNS.md):**
- Context misuse on line 96 of monitor.go (uses context.Background() instead of parent context)
- Ignored I/O errors in qbittorrent/client.go (lines 57, 144)
- Cookie jar initialization error ignored (line 23)
- No resilience when qBittorrent becomes unavailable

**From Phase 2 CONTEXT.md:**
- Essential: Reliable completion detection (never miss when download finishes)
- Required: Graceful degradation if qBittorrent unavailable (keep trying without crashing)
- Focus: State transition tracking (queued → downloading → seeding)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix monitor bugs and add resilience</name>
  <files>backend/internal/downloads/monitor.go, backend/internal/qbittorrent/client.go</files>
  <action>
    **In monitor.go:**
    1. Line 96: Replace `context.Background()` with a properly derived context that respects monitor cancellation. Create context with timeout for organization goroutines (e.g., `context.WithTimeout(ctx, 5*time.Minute)`) to allow graceful completion but prevent indefinite hanging.
    2. Add resilience for qBittorrent unavailability in checkDownloads():
       - Wrap GetTorrentStatus() call in error handling
       - On connection errors (not just timeouts), log warning and continue to next download instead of stopping
       - Add exponential backoff if ALL downloads fail (suggests qBittorrent is down)
       - Continue monitoring loop even when qBittorrent temporarily unavailable
    3. Improve state transition logging:
       - Log when download state changes (queued → downloading, downloading → completed)
       - Include download ID, title, and old/new states in log messages
       - Only log state transitions, not every poll (reduces noise)

    **In qbittorrent/client.go:**
    1. Line 57: Check and return error from io.ReadAll(resp.Body) in Login() method. Wrap with fmt.Errorf("failed to read login response: %w", err)
    2. Line 144: Check and return error from io.ReadAll(resp.Body) in GetTorrentStatus() error handler (currently in error branch). If read fails, use generic message.
    3. Line 23: Check error from cookiejar.New(nil), return error from NewClient() if cookie jar creation fails. Change NewClient signature to return (*Client, error).
    4. Update main.go line 64 to handle NewClient error: `qbClient, err := qbittorrent.NewClient(...); if err != nil { return fmt.Errorf("failed to create qBittorrent client: %w", err) }`

    **What to avoid:**
    - Don't add retry logic at the per-download level (that's for Phase 4 organization)
    - Don't stop the entire monitor if one download fails (continue to others)
    - Don't use panics for error handling (return errors)
    - Don't over-log - only log state transitions, not every poll iteration
  </action>
  <verify>
    1. `go build ./cmd/api` succeeds without errors
    2. Run monitor with qBittorrent unavailable - should log warnings but continue running
    3. Check logs show state transitions with download ID and state names
    4. Graceful shutdown (Ctrl+C) completes without hanging goroutines
  </verify>
  <done>
    - Context properly propagated to organization goroutines
    - All I/O errors checked and handled
    - Cookie jar creation error checked
    - Monitor continues running when qBittorrent temporarily unavailable
    - State transitions logged clearly
    - Build succeeds, graceful shutdown works
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Refined download monitor with bug fixes, resilience, and improved logging</what-built>
  <how-to-verify>
    1. Start backend: `cd backend && go run ./cmd/api`
    2. Add a download through the frontend (http://localhost:3000)
    3. Monitor backend logs for state transition messages (should see "Download [ID] state changed: queued → downloading")
    4. Stop qBittorrent temporarily (simulate unavailability)
    5. Verify backend logs show warnings but monitor continues running
    6. Restart qBittorrent
    7. Verify monitor resumes checking downloads
    8. Wait for download to complete
    9. Verify completion detected and logged
    10. Send SIGINT (Ctrl+C) and verify graceful shutdown completes within 10 seconds
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `go build ./cmd/api` succeeds
- [ ] Monitor continues running when qBittorrent unavailable
- [ ] State transitions logged clearly with download IDs
- [ ] Graceful shutdown completes without hanging
- [ ] End-to-end test passes (download → monitor detects completion)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Known bugs from CONCERNS.md fixed (context misuse, ignored I/O errors)
- Resilience requirements from CONTEXT.md met (graceful degradation)
- Monitor reliably detects completion without missing downloads
</success_criteria>

<output>
After completion, create `.planning/phases/02-download-monitoring/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Download Monitoring Refinement Summary

**[Substantive one-liner - what was fixed/improved]**

## Accomplishments

- Fixed context misuse in organization goroutines
- Added resilience for qBittorrent unavailability
- Improved state transition logging
- Fixed ignored I/O errors in qBittorrent client

## Files Created/Modified

- `backend/internal/downloads/monitor.go` - Fixed context usage, added resilience, improved logging
- `backend/internal/qbittorrent/client.go` - Fixed ignored I/O errors, added cookie jar error handling
- `backend/cmd/api/main.go` - Handle NewClient error

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 2 complete. Ready for Phase 3 (Configuration System).
</output>
