---
phase: 19-volume-path-management
plan: 01
type: execute
---

<objective>
Configure Docker volume mounting for qBittorrent downloads and organized audiobooks with comprehensive documentation for Unraid deployment.

Purpose: Enable containerized deployment to access qBittorrent downloads and organize audiobooks to persistent storage locations.
Output: Updated docker-compose.yml with volume mounts, deployment documentation with path mapping examples, and tested volume configuration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-docker-compose-setup/17-01-SUMMARY.md
@.planning/phases/18-environment-configuration/18-01-SUMMARY.md
@.planning/codebase/STACK.md
@.planning/codebase/STRUCTURE.md
@docker-compose.yml
@.env.example
@backend/internal/downloads/organization.go

**Tech stack available:** Docker Compose, environment variables with godotenv
**Established patterns:**
- Environment variable precedence (ENV > Database > Defaults)
- Named volumes for database persistence at /data
- Non-root containers with proper ownership
- Health check dependencies between services

**Constraining decisions:**
- Phase 17: Database volume mounted at /data with ORGANIZR_DB_PATH=/data/organizr.db
- Phase 18: Environment variables for all configuration including PATHS_DESTINATION and PATHS_LOCAL_MOUNT
- Existing code: organization.go prepends PATHS_LOCAL_MOUNT to qBittorrent file paths (lines 94-103)

**Context:**
The organization service expects:
1. PATHS_LOCAL_MOUNT to prepend to qBittorrent-reported paths (for accessing downloads from container)
2. PATHS_DESTINATION as base directory for organized audiobooks
3. Both paths need volume mounting in Docker for container file access

Typical Unraid scenario:
- qBittorrent container saves downloads to /downloads (mapped to host /mnt/user/downloads)
- Audiobookshelf expects audiobooks at /audiobooks (mapped to host /mnt/user/audiobooks)
- Organizr container needs access to both locations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add volume mounts to docker-compose.yml</name>
  <files>docker-compose.yml</files>
  <action>
Add two volume mounts to backend service for qBittorrent downloads and audiobook destination:

1. Downloads volume (source - where qBittorrent saves torrents):
   - Mount: qbittorrent-downloads:/downloads
   - Purpose: Access qBittorrent completed downloads
   - Type: Named volume (for Docker Compose), will be host path in production

2. Audiobooks volume (destination - where organized files go):
   - Mount: audiobooks:/audiobooks
   - Purpose: Write organized audiobooks for Audiobookshelf
   - Type: Named volume (for Docker Compose), will be host path in production

Add named volume definitions in volumes section:
- qbittorrent-downloads with driver: local
- audiobooks with driver: local

Update backend service environment section to set sensible defaults:
- PATHS_LOCAL_MOUNT=/downloads (matches downloads mount)
- PATHS_DESTINATION=/audiobooks (matches audiobooks mount)

Do NOT modify frontend service (doesn't need file access).
Do NOT modify existing organizr-data volume (database persistence working correctly).
  </action>
  <verify>docker-compose config validates without errors, volumes section shows all three volumes (organizr-data, qbittorrent-downloads, audiobooks)</verify>
  <done>Backend service has two new volume mounts, volumes section declares both, default environment variables point to mount paths</done>
</task>

<task type="auto">
  <name>Task 2: Update .env.example with volume documentation</name>
  <files>.env.example</files>
  <action>
Add comprehensive documentation section above PATHS_DESTINATION explaining Docker volume mapping for production deployment:

```
# ==============================================================================
# Docker Volume Configuration
# ==============================================================================
# For production deployment (Unraid, Synology, etc.), replace named volumes
# in docker-compose.yml with host paths. Example:
#
# volumes:
#   - /mnt/user/downloads:/downloads          # qBittorrent download location
#   - /mnt/user/audiobooks:/audiobooks        # Audiobookshelf library location
#   - /mnt/user/appdata/organizr:/data        # Database persistence
#
# Then configure these environment variables to match the container paths:
# ==============================================================================
```

Update PATHS_DESTINATION comment to reference Docker volume:
- Add note: "In Docker: Maps to volume mount (e.g., /audiobooks inside container)"
- Add example: "Host path example: /mnt/user/audiobooks (Unraid)"

Update PATHS_LOCAL_MOUNT comment to be more explicit:
- Current: "Local mount point for qBittorrent downloads (leave empty for local qBittorrent)"
- New: "Container path where qBittorrent downloads are accessible (empty for same-host qBittorrent)"
- Add Docker example: "Docker example: /downloads (maps to qBittorrent's download directory via volume mount)"
- Add note: "See Docker Volume Configuration section above for volume mapping"

Keep all existing content, only add/enhance comments.
  </action>
  <verify>cat .env.example | grep -A 10 "Docker Volume Configuration" shows new documentation section, PATHS comments reference Docker volumes</verify>
  <done>.env.example has Docker volume documentation section and enhanced path configuration comments with container/host path examples</done>
</task>

<task type="auto">
  <name>Task 3: Create deployment documentation for Unraid</name>
  <files>docs/DEPLOYMENT.md</files>
  <action>
Create comprehensive deployment guide at docs/DEPLOYMENT.md covering:

# Deployment Guide

## Overview
Brief intro: Organizr runs in Docker containers, requires volume mounts to access qBittorrent downloads and write organized audiobooks.

## Prerequisites
- Docker and Docker Compose installed
- qBittorrent with Web UI enabled (running on host or in container)
- MyAnonamouse account with API secret
- Storage paths for downloads and audiobooks

## Unraid Deployment

### Step 1: Prepare Directories
Explain typical Unraid paths:
- /mnt/user/downloads - qBittorrent download location
- /mnt/user/audiobooks - Audiobookshelf library
- /mnt/user/appdata/organizr - Organizr database

### Step 2: Configure docker-compose.yml
Show example replacing named volumes with host paths:
```yaml
services:
  backend:
    volumes:
      - /mnt/user/downloads:/downloads
      - /mnt/user/audiobooks:/audiobooks
      - /mnt/user/appdata/organizr:/data
```

### Step 3: Configure Environment Variables
Copy .env.example to .env and set:
- QBITTORRENT_URL (if qBittorrent in container: http://container-name:8080, if on host: http://host.docker.internal:8080)
- QBITTORRENT_USERNAME and QBITTORRENT_PASSWORD
- MAM_SECRET
- PATHS_LOCAL_MOUNT=/downloads (container path to qBittorrent downloads)
- PATHS_DESTINATION=/audiobooks (container path for organized files)
- PATHS_TEMPLATE and PATHS_NO_SERIES_TEMPLATE (customize folder structure)

### Step 4: Start Services
```bash
docker-compose up -d
```
Check logs: docker-compose logs -f

### Step 5: Verify Configuration
- Access frontend: http://unraid-ip:8081
- Test qBittorrent connection in Settings
- Search for audiobook and download
- Verify files organized to /mnt/user/audiobooks

## Troubleshooting

### qBittorrent Connection Failed
- Check QBITTORRENT_URL points to correct host/port
- Verify qBittorrent Web UI enabled
- Check credentials correct
- Test from container: docker-compose exec backend wget -O- http://qbittorrent:8080

### Files Not Organizing
- Verify PATHS_LOCAL_MOUNT matches qBittorrent download volume mount
- Check logs: docker-compose logs backend | grep -i error
- Verify permissions: ls -la /mnt/user/downloads
- Confirm qBittorrent download completion (not paused/seeding-only)

### Permission Errors
- Containers run as uid/gid 1001 (non-root)
- Ensure host directories readable/writable by uid 1001
- Unraid: Set "Nobody" user permissions on shares

### Database Issues
- Database location: /mnt/user/appdata/organizr/organizr.db
- Backup: Copy .db, .db-shm, .db-wal files
- Reset: Stop containers, delete database files, restart

## Docker Compose Deployment (non-Unraid)

Brief section covering general Docker Compose usage:
- Same volume mapping approach
- Adjust host paths to your system
- qBittorrent in Docker: Use Docker network names
- qBittorrent on host: Use host.docker.internal (Mac/Windows) or host IP (Linux)

## Alternative: Unraid Community Applications Template

Note: Future enhancement - currently deploy via docker-compose.
Community template would provide UI-based configuration for Unraid users.

Include all sections with clear headings, code blocks for examples, troubleshooting steps for common issues.
  </action>
  <verify>cat docs/DEPLOYMENT.md | grep -E "Unraid|qBittorrent|volumes" confirms all sections present, file is well-structured markdown</verify>
  <done>docs/DEPLOYMENT.md created with comprehensive Unraid deployment guide including volume mounting, environment configuration, and troubleshooting</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] docker-compose config validates successfully
- [ ] docker-compose.yml has qbittorrent-downloads and audiobooks volume mounts
- [ ] .env.example has Docker volume documentation section
- [ ] docs/DEPLOYMENT.md exists and covers Unraid deployment
- [ ] All files committed with appropriate messages
</verification>

<success_criteria>

- docker-compose.yml has two new volume mounts for backend service (downloads and audiobooks)
- Named volumes declared in volumes section (qbittorrent-downloads, audiobooks)
- Default environment variables set for PATHS_LOCAL_MOUNT and PATHS_DESTINATION
- .env.example enhanced with Docker volume configuration documentation
- docs/DEPLOYMENT.md created with comprehensive Unraid deployment guide
- Documentation covers volume mapping, environment variables, and troubleshooting
- No errors in docker-compose config validation
</success_criteria>

<output>
After completion, create `.planning/phases/19-volume-path-management/19-01-SUMMARY.md`:

# Phase 19 Plan 01: Volume & Path Management Summary

**[One-line summary of what shipped]**

## Accomplishments

- Added qBittorrent downloads and audiobooks volume mounts to docker-compose.yml
- Enhanced .env.example with Docker volume configuration documentation
- Created comprehensive Unraid deployment guide with volume mapping examples
- Documented troubleshooting steps for common deployment issues

## Files Created/Modified

- `docker-compose.yml` - Added qbittorrent-downloads and audiobooks volume mounts
- `.env.example` - Added Docker volume configuration section and enhanced path comments
- `docs/DEPLOYMENT.md` - New comprehensive deployment guide for Unraid

## Decisions Made

[Document any decisions made during implementation]

## Issues Encountered

[Document any problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 20 (Deployment Documentation). Docker volume configuration complete with:
- Volume mounts for downloads and audiobooks
- Environment variables configured for container paths
- Comprehensive Unraid deployment guide
- Troubleshooting documentation

Phase 20 will enhance README with quick start guide and reference deployment documentation.
</output>
