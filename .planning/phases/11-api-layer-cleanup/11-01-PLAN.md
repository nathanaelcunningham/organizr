---
phase: 11-api-layer-cleanup
plan: 01
type: execute
---

<objective>
Standardize error handling across the API layer with consistent error types and helper functions.

Purpose: Improve error response consistency, reduce code duplication, and provide better error messages to API clients.
Output: Centralized error handling with typed error helpers, all handlers using consistent error patterns.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# Current error handling
@backend/internal/server/errors.go
@backend/internal/server/handlers.go

# Architecture decisions from Phase 10
@docs/architecture/ADR.md

**Current error handling state:**
- Basic `respondWithError()` and `respondWithJSON()` helpers exist
- `ErrorResponse` struct with error, message, code fields
- 71 instances of error responses across handlers
- Inconsistent error message patterns
- No typed error helpers for common cases

**Established patterns:**
- User-friendly error messages without exposing internals
- Centralized error response in errors.go
- All errors logged before returning to client
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create typed error helpers</name>
  <files>backend/internal/server/errors.go</files>
  <action>
Extend the errors.go file with typed error helper functions for common HTTP error cases:

1. Add helper functions:
   - `respondWithNotFound(w, resource string, err error)` - 404 with "Resource not found: {resource}"
   - `respondWithBadRequest(w, reason string, err error)` - 400 with custom reason
   - `respondWithValidationError(w, field string, err error)` - 400 with "Validation failed: {field}"
   - `respondWithInternalError(w, operation string, err error)` - 500 with "Failed to {operation}"

2. Keep existing `respondWithError()` for custom cases
3. Keep existing `respondWithJSON()` for success responses
4. Maintain current logging behavior (log all errors with context)
5. Follow Go naming conventions (camelCase for unexported)

WHY these helpers: Reduces duplication of status codes and error message patterns, makes error responses more consistent across all endpoints.

WHY not a map/enum approach: Function-based helpers provide type safety and clear documentation of available error types at call site.
  </action>
  <verify>
go build backend/cmd/api && go test backend/internal/server/... passes
Check errors.go exports new helper functions with correct signatures
  </verify>
  <done>
Four new error helper functions exist in errors.go
Each helper has clear documentation comments
All helpers follow existing logging and response patterns
Build and tests pass without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor handlers to use typed error helpers</name>
  <files>backend/internal/server/handlers.go</files>
  <action>
Replace all `respondWithError()` calls in handlers with the appropriate typed helper:

1. Replace 404 errors with `respondWithNotFound()` - examples:
   - "Download not found" → `respondWithNotFound(w, "download", err)`
   - "Config not found" → `respondWithNotFound(w, "config", err)`

2. Replace validation errors (400) with `respondWithValidationError()` - examples:
   - "Download ID is required" → `respondWithValidationError(w, "download ID", nil)`
   - "Invalid download ID" → `respondWithValidationError(w, "download ID", err)`
   - "Query must be at least 2 characters" → `respondWithValidationError(w, "query length", nil)`

3. Replace bad request errors with `respondWithBadRequest()` - examples:
   - "Invalid request body" → `respondWithBadRequest(w, "invalid request body", err)`
   - "Batch size exceeds limit" → `respondWithBadRequest(w, "batch size exceeds 50 item limit", nil)`

4. Replace 500 errors with `respondWithInternalError()` - examples:
   - "Failed to create download" → `respondWithInternalError(w, "create download", err)`
   - "Failed to list downloads" → `respondWithInternalError(w, "list downloads", err)`
   - "Search failed" → `respondWithInternalError(w, "search", err)`

5. Keep success responses with `respondWithJSON()` unchanged

Refactor all ~71 error instances systematically. Review handlers.go line by line.

WHY this refactor: Eliminates hardcoded status codes in handlers, makes error patterns consistent and easier to maintain.
  </action>
  <verify>
go build backend/cmd/api succeeds
go test backend/internal/server/... passes (all existing handler tests still work)
grep -c "respondWithError" backend/internal/server/handlers.go returns 0 (all replaced)
All error responses now use typed helpers
  </verify>
  <done>
All error responses in handlers use typed error helpers
No direct `respondWithError()` calls remain in handlers.go
All status codes removed from handler calls (now in helpers)
Build passes and all tests pass
Error messages are consistent and user-friendly
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build backend/cmd/api` succeeds without errors
- [ ] `go test backend/internal/server/...` passes all tests
- [ ] `grep "respondWithError" backend/internal/server/handlers.go` returns no results
- [ ] All error responses use typed helpers (NotFound, BadRequest, Validation, Internal)
- [ ] Error messages follow consistent patterns
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Four new typed error helpers exist in errors.go
- All handlers use typed error helpers instead of direct respondWithError
- No TypeScript or Go compilation errors
- All existing tests still pass
- Error response patterns are consistent across API
</success_criteria>

<output>
After completion, create `.planning/phases/11-api-layer-cleanup/11-01-SUMMARY.md`:

# Phase 11 Plan 1: Error Handling Standardization Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 11-02-PLAN.md (OpenAPI/Swagger Documentation)
</output>
