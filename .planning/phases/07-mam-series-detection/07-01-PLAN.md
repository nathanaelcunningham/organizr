---
phase: 07-mam-series-detection
plan: 01
type: execute
---

<objective>
Update backend to parse and return structured series data from MAM API instead of concatenated strings.

Purpose: Enable frontend to group and sort search results by series name and book number.
Output: Backend returns array of series objects with name and number fields, supporting multiple series per book.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-mam-series-detection/07-CONTEXT.md
@.planning/phases/07-mam-series-detection/07-RESEARCH.md
@backend/internal/search/providers/mam.go
@backend/internal/server/dto.go
@backend/internal/models/search.go

**Current state**: The `formatSeriesInfo()` function (lines 298-303) has book number parsing commented out and returns concatenated strings. Frontend receives series as a single string, preventing proper grouping/sorting.

**Research findings**: MAM API provides structured JSON in `series_info` field with format `{"123": ["Series Name", "Book Number", numeric_value]}`. Need to preserve both name and number in structured format.

**Key constraints**:
- Books can belong to multiple series (array, not single value)
- Book numbers can be various formats ("1", "Book 1", "1.5")
- Must maintain backward compatibility during API transition
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update backend models for structured series data</name>
  <files>backend/internal/models/search.go, backend/internal/server/dto.go</files>
  <action>
    In models/search.go:
    - Add new SeriesInfo struct with ID, Name, and Number fields (all strings)
    - Change SearchResult.Series from string to []SeriesInfo (array to support multiple series)

    In server/dto.go:
    - Update searchResultDTO.Series from string to []SeriesInfo
    - Update searchResultToDTO() to map the array directly (no transformation needed)

    Use SeriesInfo struct definition from RESEARCH.md code examples (lines 243-248). Keep all fields as strings - Number can be "1", "Book 1", "1.5", etc. Frontend will handle parsing.
  </action>
  <verify>go build ./backend/... succeeds with no compilation errors</verify>
  <done>Models updated, Series field is array of SeriesInfo structs, builds cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite series parsing to return structured data</name>
  <files>backend/internal/search/providers/mam.go</files>
  <action>
    Replace formatSeriesInfo() function (lines 280-310):
    - Rename to parseSeriesInfo() to reflect structured return type
    - Change return type from string to []models.SeriesInfo
    - Implement JSON parsing logic from RESEARCH.md (lines 250-283)
    - Extract ID, Name, and Number from MAM's {"id": ["name", "number", numeric]} format
    - Return empty array if seriesInfo is empty or parsing fails (graceful degradation)
    - DO NOT concatenate strings - preserve structured data

    Update Search() method to call parseSeriesInfo() instead of formatSeriesInfo() and assign to SearchResult.Series directly.

    Why this approach: Structured data enables frontend sorting/grouping. String concatenation destroys the information needed for proper organization.
  </action>
  <verify>go test ./backend/internal/search/providers/... passes (if tests exist), or manual test: search MAM and check that Series field is array in API response</verify>
  <done>parseSeriesInfo returns []SeriesInfo, Search results include structured series data, API returns array not string</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./backend/...` succeeds without errors
- [ ] `go test ./backend/...` passes (if tests exist)
- [ ] Manual API test: POST /api/search returns results with series as array of objects
- [ ] Books with multiple series show multiple SeriesInfo objects
- [ ] Books without series have empty array (not null)
</verification>

<success_criteria>

- All tasks completed
- Backend models use []SeriesInfo instead of string
- parseSeriesInfo extracts name and number from MAM API
- API responses include structured series data
- No compilation errors or test failures
</success_criteria>

<output>
After completion, create `.planning/phases/07-mam-series-detection/07-01-SUMMARY.md`:

# Phase 7 Plan 1: Backend Series Parsing Summary

**Backend now returns structured series data enabling frontend grouping and sorting**

## Accomplishments

- Updated SearchResult model to use []SeriesInfo (array of structs)
- Implemented parseSeriesInfo() to extract name and number from MAM JSON
- API now returns series as structured array instead of concatenated strings

## Files Created/Modified

- `backend/internal/models/search.go` - Added SeriesInfo struct, changed Series field type
- `backend/internal/server/dto.go` - Updated DTO to use []SeriesInfo
- `backend/internal/search/providers/mam.go` - Rewrote series parsing logic

## Decisions Made

- Keep all SeriesInfo fields as strings (Number can be "1", "Book 1", "1.5") - frontend handles parsing
- Return empty array for books without series (not null) - consistent API responses
- Preserve multiple series per book in array - better data fidelity

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 07-02-PLAN.md (Frontend series grouping and display)
</output>
