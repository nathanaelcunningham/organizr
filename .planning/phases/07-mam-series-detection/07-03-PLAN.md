---
phase: 07-mam-series-detection
plan: 03
type: execute
---

<objective>
Add pre-download confirmation modal allowing users to review and edit metadata (author, title, series, category) before submitting to backend.

Purpose: Ensure accurate metadata before download starts, prevent mistakes, give users control over final organization.
Output: Accessible confirmation dialog with editable fields, integrates into existing download flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-mam-series-detection/07-CONTEXT.md
@.planning/phases/07-mam-series-detection/07-RESEARCH.md
@.planning/phases/07-mam-series-detection/07-01-SUMMARY.md
@.planning/phases/07-mam-series-detection/07-02-SUMMARY.md
@frontend/src/components/search/SearchResultListItem.tsx
@frontend/src/stores/useDownloadStore.ts

**Prior plans completed**: Backend returns structured series (07-01), frontend groups results by series (07-02).

**Current download flow**: SearchResultListItem.tsx (lines 22-39) calls createDownload() immediately on button click, navigates to /downloads. No review step.

**Research findings**: Use native `<dialog>` element with showModal() for accessibility (RESEARCH.md lines 327-425). React Hook Form already in project stack for form handling. Focus management and ESC key handled automatically by native dialog.

**Key constraints**:
- Must be accessible (keyboard navigation, focus trap, ARIA labels)
- Allow editing all metadata fields (author, title, series, category)
- Preserve existing download flow if modal is cancelled
- Support multiple series - format as comma-separated string for backend compatibility
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DownloadConfirmModal component</name>
  <files>frontend/src/components/common/DownloadConfirmModal.tsx</files>
  <action>
    Create new modal component following RESEARCH.md pattern (lines 327-425):
    - Use native `<dialog>` element with ref and useEffect for showModal()/close() lifecycle
    - Props: isOpen (boolean), onClose (callback), onConfirm (callback with metadata), initialData (author, title, series, category)
    - Use react-hook-form (already in package.json) for form state with defaultValues from initialData
    - Four input fields: Author, Title, Series, Category (all text inputs)
    - For series field: format multiple series as comma-separated string (e.g., "Series A, Series B") in initialData
    - Two buttons: "Cancel" (calls onClose) and "Download" (calls handleSubmit -> onConfirm)
    - ARIA attributes: aria-labelledby pointing to h2 id, aria-describedby for description
    - Tailwind classes: backdrop:bg-black backdrop:opacity-50 for semi-transparent background
    - ESC key and backdrop click handled automatically by native dialog

    Why native dialog: Better browser support (baseline 2022), automatic focus management, simpler than react-modal. Already have react-hook-form in stack for validation.
  </action>
  <verify>npm run build succeeds, modal component exports correctly</verify>
  <done>DownloadConfirmModal created, uses native dialog, react-hook-form integrated, ARIA attributes present, builds cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Integrate confirmation modal into download flow</name>
  <files>frontend/src/components/search/SearchResultListItem.tsx</files>
  <action>
    Update SearchResultListItem download flow (lines 22-39):
    - Import DownloadConfirmModal component
    - Add state: `const [showConfirmModal, setShowConfirmModal] = useState(false)`
    - Prepare initialData object from result: author, title, series (format as comma-separated string if array), category (empty string if not present)
    - Change handleDownload to: `setShowConfirmModal(true)` instead of immediate createDownload
    - Create new handleConfirm callback that receives edited metadata and calls createDownload with updated values
    - Render DownloadConfirmModal at end of component JSX with:
      * isOpen={showConfirmModal}
      * onClose={() => setShowConfirmModal(false)}
      * onConfirm={handleConfirm}
      * initialData={prepared data object}
    - Keep downloading state for button loading indicator
    - Keep navigation to /downloads after successful creation

    Helper for series formatting: If result.series is array, join with ", " to create string. Empty array becomes empty string.

    Why this approach: Minimal disruption to existing flow. Modal appears on download click instead of immediate submission. User can edit or cancel. Confirmation proceeds with original flow (createDownload + navigate).
  </action>
  <verify>npm run dev, click download on search result, modal appears with pre-filled data, can edit fields, cancel closes modal, confirm creates download and navigates</verify>
  <done>Modal integrated into download flow, appears on download click, fields editable, cancel/confirm work correctly, no regressions in download functionality</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run dev` starts development server
- [ ] Click download button opens confirmation modal
- [ ] Modal shows pre-filled author, title, series, category
- [ ] Can edit all fields in modal
- [ ] ESC key closes modal without downloading
- [ ] Cancel button closes modal without downloading
- [ ] Download button in modal creates download and navigates to /downloads
- [ ] Keyboard navigation works (Tab cycles through fields and buttons)
- [ ] Focus trapped within modal (can't tab to background content)
</verification>

<success_criteria>

- All tasks completed
- DownloadConfirmModal component created with native dialog
- Modal integrated into SearchResultListItem download flow
- Pre-download confirmation works with editable metadata
- Accessible (ARIA labels, focus management, keyboard navigation)
- No TypeScript errors or console warnings
- Phase 7 complete: Series detection and confirmation flow working end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/07-mam-series-detection/07-03-SUMMARY.md`:

# Phase 7 Plan 3: Download Confirmation Modal Summary

**Users can now review and edit metadata before downloading**

## Accomplishments

- Created DownloadConfirmModal with native dialog element
- Integrated react-hook-form for form state management
- Added pre-download confirmation step to search result flow
- Implemented accessible modal with proper ARIA and focus management

## Files Created/Modified

- `frontend/src/components/common/DownloadConfirmModal.tsx` - NEW: Confirmation dialog with editable metadata
- `frontend/src/components/search/SearchResultListItem.tsx` - Updated download flow to show confirmation modal

## Decisions Made

- Native `<dialog>` over react-modal for simplicity and built-in accessibility
- Format multiple series as comma-separated string for backend compatibility
- Modal triggered by download button, doesn't auto-show on result selection

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase

Phase 7 complete. Ready for Phase 8 (Batch Operations) or milestone review.

---

# Phase 7: MAM Series Detection - Complete

**Series information now parsed, displayed, and confirmed before download**

## Overall Accomplishments

- Backend parses structured series data from MAM (name + number per series)
- Search results grouped by series with books sorted numerically
- Pre-download confirmation modal for metadata review
- Support for books in multiple series

## Key Files Changed

**Backend (3 files):**
- `backend/internal/models/search.go` - SeriesInfo struct, Series as array
- `backend/internal/server/dto.go` - DTO updated for structured series
- `backend/internal/search/providers/mam.go` - parseSeriesInfo implementation

**Frontend (7 files):**
- `frontend/src/types/search.ts` - SeriesInfo type, SearchResult.series as array
- `frontend/src/utils/groupSeries.ts` - NEW: Grouping and sorting logic
- `frontend/src/components/search/SeriesGroup.tsx` - NEW: Series group display
- `frontend/src/components/search/SearchResults.tsx` - Renders grouped series
- `frontend/src/components/search/SearchResultListItem.tsx` - Series number display, modal integration
- `frontend/src/components/common/DownloadConfirmModal.tsx` - NEW: Confirmation dialog

## Architecture Decisions

- Structured data over string concatenation enables sorting/grouping
- Client-side grouping with native Array methods (no dependencies)
- Native dialog element for accessibility without library weight
- Books in multiple series appear in each group (better discoverability)

## Testing Notes

Manual testing completed for:
- Series parsing from MAM API
- Grouped display with numerical ordering
- Confirmation modal accessibility
- Edit and confirm flow

## Phase Complete

Phase 7 (MAM Series Detection) complete. All 3 plans executed successfully.
</output>
