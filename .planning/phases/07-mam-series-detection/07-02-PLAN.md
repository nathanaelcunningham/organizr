---
phase: 07-mam-series-detection
plan: 02
type: execute
---

<objective>
Implement frontend series grouping and display to organize search results by series with books sorted by number.

Purpose: Make series relationships obvious in search results so users can quickly find books in order.
Output: Search results visually grouped by series name with books sorted numerically within each group.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-mam-series-detection/07-CONTEXT.md
@.planning/phases/07-mam-series-detection/07-RESEARCH.md
@.planning/phases/07-mam-series-detection/07-01-SUMMARY.md
@frontend/src/types/search.ts
@frontend/src/components/search/SearchResults.tsx
@frontend/src/components/search/SearchResultListItem.tsx

**Backend completed**: Plan 07-01 updated backend to return structured series data ([]SeriesInfo with name and number fields).

**Current frontend state**: SearchResults.tsx displays flat list of results (lines 75-87). SearchResultListItem shows series as string in expanded section (lines 196-199).

**Research findings**: Use Array.reduce() for grouping (RESEARCH.md lines 99-115), Array.sort() for sorting by number (lines 117-130), useMemo() for performance (lines 296-323). Don't mutate arrays during sort - use spread operator.

**Key constraints**:
- Books can belong to multiple series - show in each series group
- Standalone books (no series) go in separate "Standalone" group
- Book numbers vary ("1", "Book 1", "1.5") - parseFloat() with fallback
- Clean visual separation between series groups
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update frontend types and create grouping utility</name>
  <files>frontend/src/types/search.ts, frontend/src/utils/groupSeries.ts</files>
  <action>
    In types/search.ts:
    - Add SeriesInfo interface with id, name, and number fields (all strings)
    - Change SearchResult.series from optional string to optional array: `series?: SeriesInfo[]`
    - Keep all other fields unchanged

    Create new file utils/groupSeries.ts:
    - Export interface SeriesGroup with seriesName (string) and books (SearchResult[])
    - Implement groupBySeries(results: SearchResult[]): SeriesGroup[] using the pattern from RESEARCH.md lines 296-323
    - Use Array.reduce() to group by series name, handle books without series as "Standalone" group
    - Sort books within each series by parseFloat(number) ascending
    - Use useMemo-style logic (can be applied in component later)
    - Use spread operator `[...books].sort()` to avoid mutation

    Why these patterns: Native Array methods are performant and well-understood. Separate utility keeps logic testable and reusable.
  </action>
  <verify>npm run build succeeds, TypeScript compilation passes with no errors</verify>
  <done>SeriesInfo type added, SearchResult.series is array, groupBySeries utility created and exports SeriesGroup[], no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: Create SeriesGroup component for visual organization</name>
  <files>frontend/src/components/search/SeriesGroup.tsx</files>
  <action>
    Create new component SeriesGroup.tsx following the pattern from RESEARCH.md lines 428-452:
    - Props: seriesName (string), books (SearchResult[]), onBookAction (optional callback)
    - Display series name as header with book count (e.g., "Series Name (5 books)")
    - Use distinct background for header (e.g., bg-gray-100) for visual separation
    - Render each book using existing SearchResultListItem component
    - Wrap books in border container with divide-y for clean row separation
    - Add prop to SearchResultListItem: showSeriesNumber (boolean) - pass true for series books, false for standalone
    - Update SearchResultListItem to display series number in title area when showSeriesNumber is true

    Follow existing component patterns (see STRUCTURE.md): Tailwind for styling, TypeScript with React.FC, clean semantic JSX.

    Why this approach: Dedicated component for series groups maintains single responsibility. Reusing SearchResultListItem avoids duplication. Visual hierarchy makes series boundaries obvious.
  </action>
  <verify>npm run build succeeds, SeriesGroup component renders without errors</verify>
  <done>SeriesGroup component created, displays series header and book list, integrates with SearchResultListItem, builds cleanly</done>
</task>

<task type="auto">
  <name>Task 3: Update SearchResults to use series grouping</name>
  <files>frontend/src/components/search/SearchResults.tsx, frontend/src/components/search/SearchResultListItem.tsx</files>
  <action>
    In SearchResults.tsx:
    - Import groupBySeries utility and SeriesGroup component
    - Add useMemo to group results: `const grouped = useMemo(() => groupBySeries(results), [results])`
    - Replace flat results map (lines 81-83) with grouped rendering:
      * Map over grouped array
      * Render SeriesGroup for each group
      * Pass seriesName and books to SeriesGroup
    - Keep loading, error, and empty state logic unchanged (lines 18-73)
    - Update "Found X results" text to show number of series groups + total books

    In SearchResultListItem.tsx:
    - Add optional prop showSeriesNumber?: boolean (default false)
    - When showSeriesNumber is true, display series number next to title (e.g., "Title (Book 1)")
    - Extract number from result.series[0]?.number if available
    - Keep all existing functionality unchanged (expand/collapse, download, metadata)

    Why this approach: useMemo caches grouped results for performance. Component-based architecture keeps concerns separated. Minimal changes to existing list item preserve existing UX.
  </action>
  <verify>npm run dev, visit search page, search MAM, confirm results grouped by series with books in order, standalone books in separate group</verify>
  <done>SearchResults uses groupBySeries with useMemo, renders SeriesGroup components, books appear in series order, visual grouping clear, no regressions in existing functionality</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] `npm run dev` starts development server
- [ ] Search MAM for series (e.g., "Discworld") shows grouped results
- [ ] Books within series are sorted by number (1, 2, 3...)
- [ ] Standalone books appear in separate "Standalone" group
- [ ] Books belonging to multiple series appear in each respective group
- [ ] Existing functionality preserved (expand/collapse, download button)
</verification>

<success_criteria>

- All tasks completed
- Frontend types updated to use SeriesInfo[]
- Grouping utility implemented with reduce and sort
- SeriesGroup component displays series with clear visual separation
- SearchResults renders grouped series instead of flat list
- Books sorted numerically within series
- No TypeScript errors or console warnings
</success_criteria>

<output>
After completion, create `.planning/phases/07-mam-series-detection/07-02-SUMMARY.md`:

# Phase 7 Plan 2: Frontend Series Grouping Summary

**Search results now grouped by series with books in numerical order**

## Accomplishments

- Created groupBySeries utility using Array.reduce() and sort()
- Built SeriesGroup component for visual series organization
- Updated SearchResults to display grouped series instead of flat list
- Added series number display in result items

## Files Created/Modified

- `frontend/src/types/search.ts` - Added SeriesInfo type, updated SearchResult.series to array
- `frontend/src/utils/groupSeries.ts` - NEW: Grouping and sorting logic
- `frontend/src/components/search/SeriesGroup.tsx` - NEW: Series group display component
- `frontend/src/components/search/SearchResults.tsx` - Updated to render grouped series
- `frontend/src/components/search/SearchResultListItem.tsx` - Added series number display

## Decisions Made

- Books in multiple series appear in each group (better discoverability than picking "primary" series)
- parseFloat() for book number sorting with fallback to 999 for non-numeric (pushes to end)
- useMemo caches grouped results for performance with 100+ results

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 07-03-PLAN.md (Pre-download confirmation modal)
</output>
