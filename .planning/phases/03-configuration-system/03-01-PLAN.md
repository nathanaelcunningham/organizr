---
phase: 03-configuration-system
plan: 01
type: execute
---

<objective>
Add template validation and path preview to configuration system for better user experience.

Purpose: Make the existing configuration system more user-friendly by validating templates before saving and showing preview of resulting paths.
Output: Template validation, real-time path preview, and improved help text in ConfigForm.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key context from prior phases:
@.planning/phases/02-download-monitoring/02-01-SUMMARY.md

# Existing implementation:
@backend/internal/fileutil/template.go
@backend/internal/config/service.go
@frontend/src/components/config/ConfigForm.tsx
@frontend/src/types/config.ts

**Tech stack available:**
- Backend: Go with Chi router, SQLite database
- Frontend: React 19, TypeScript, React Hook Form, Zustand, TailwindCSS
- Template system: String replacement with {placeholder} syntax

**Established patterns:**
- Service layer for business logic
- Repository pattern for data access
- API client layer with error handling
- Zustand stores for state management
- Form validation with React Hook Form

**Constraining decisions:**
- Phase 2: Path templates use {author}, {series}, {title} placeholders
- Phase 2: Template system already functional via fileutil.ParseTemplate
- Phase 1: Configuration stored in database configs table

**What already exists:**
- Configuration service (backend/internal/config/service.go) with Get/Set/GetAll methods
- Template parser (backend/internal/fileutil/template.go) with ParseTemplate function
- ConfigForm UI (frontend/src/components/config/ConfigForm.tsx) with all fields
- Path templates: paths.template and paths.no_series_template config keys
- Organization service consuming templates (backend/internal/downloads/organization.go)

**What's missing:**
- Template validation (check for valid placeholders)
- Path preview (show example output)
- Better help text showing available variables
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add template validation to backend</name>
  <files>backend/internal/fileutil/template.go, backend/internal/fileutil/template_test.go</files>
  <action>
Add ValidateTemplate function to fileutil package that checks if a template string only uses valid placeholders from an allowed list. Function signature: `ValidateTemplate(template string, allowedVars []string) error`. Returns error if template contains placeholders not in allowedVars list. Use regex to find all {placeholder} patterns, then verify each is in allowedVars. Also add unit tests in template_test.go covering: valid templates pass, invalid placeholder fails, empty template passes, template with no placeholders passes, mixed valid/invalid fails.
  </action>
  <verify>go test ./internal/fileutil/... passes with new ValidateTemplate tests</verify>
  <done>ValidateTemplate function exists, returns error for invalid placeholders, has comprehensive test coverage</done>
</task>

<task type="auto">
  <name>Task 2: Add path preview endpoint to backend</name>
  <files>backend/internal/server/handlers.go, backend/internal/server/routes.go</files>
  <action>
Add POST /api/config/preview-path endpoint that accepts JSON body with fields: template (string), author (string), series (string, optional), title (string). Use fileutil.ValidateTemplate first with allowed vars ["author", "series", "title"]. If validation fails, return 400 with error. If valid, use fileutil.ParseTemplate and fileutil.SanitizePath to generate preview path. Return JSON: {valid: bool, path: string (if valid), error: string (if invalid)}. Add route in routes.go under config group. Follow existing handler patterns from handleTestQBittorrentConnection for structure.
  </action>
  <verify>curl -X POST localhost:8090/api/config/preview-path -H "Content-Type: application/json" -d '{"template":"{author}/{title}","author":"Test Author","title":"Test Book"}' returns valid path</verify>
  <done>Endpoint returns validated path preview, handles invalid templates with 400 error, follows existing handler patterns</done>
</task>

<task type="auto">
  <name>Task 3: Add real-time path preview to frontend ConfigForm</name>
  <files>frontend/src/components/config/ConfigForm.tsx, frontend/src/api/config.ts</files>
  <action>
Add previewPath function to frontend/src/api/config.ts that calls POST /api/config/preview-path with template and example data. In ConfigForm.tsx, add PathPreview component below each template Input (pathsTemplate and pathsNoSeriesTemplate). Use useWatch from react-hook-form to track template changes. Debounce preview API calls by 500ms using existing useDebounce hook pattern. Show preview with example: "Example: /audiobooks/{generated-path}" in gray text. On validation error, show error message in red. Use existing Input help text styling for consistency. Only show preview when template is non-empty.
  </action>
  <verify>npm run dev, edit path template in ConfigForm, verify preview updates in real-time below template field</verify>
  <done>Path preview appears below template fields, updates as user types (debounced), shows validation errors, matches existing UI styling</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Template validation and path preview in configuration UI</what-built>
  <how-to-verify>
    1. Run backend: cd backend && go run cmd/api/main.go
    2. Run frontend: cd frontend && npm run dev
    3. Navigate to: http://localhost:5173/config
    4. Test path template field:
       - Enter valid template: {author}/{series}/{title} → See preview path
       - Enter invalid placeholder: {author}/{invalid} → See validation error
       - Clear template → Preview disappears
    5. Test no-series template field:
       - Enter valid template: {author}/{title} → See preview path
       - Verify preview uses example data (no series)
    6. Save configuration → No errors, preview remains accurate
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] go test ./internal/fileutil/... passes
- [ ] npm run build succeeds without errors
- [ ] Backend compiles without errors
- [ ] Template validation catches invalid placeholders
- [ ] Path preview updates in real-time
- [ ] Configuration save works with validated templates
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Template validation prevents invalid placeholders
- Path preview shows accurate example paths
- No errors or warnings introduced
- Configuration system is user-friendly and prevents misconfiguration
- Phase 3 complete (configuration system fully functional with validation)
</success_criteria>

<output>
After completion, create `.planning/phases/03-configuration-system/03-01-SUMMARY.md`:

# Phase 3 Plan 1: Configuration Template Validation and Preview Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- Template validation ensures only valid placeholders ({author}, {series}, {title})
- Real-time path preview shows example output as user types
- Validation errors displayed inline before saving
- Configuration system now prevents user mistakes

## Files Created/Modified

- `backend/internal/fileutil/template.go` - Added ValidateTemplate function
- `backend/internal/fileutil/template_test.go` - Added validation tests
- `backend/internal/server/handlers.go` - Added preview-path endpoint
- `backend/internal/server/routes.go` - Added preview-path route
- `frontend/src/api/config.ts` - Added previewPath API call
- `frontend/src/components/config/ConfigForm.tsx` - Added real-time path preview

## Decisions Made

[Key decisions and rationale, or "None"]

## Deviations from Plan

[Any deviations following deviation rules, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 3 complete. Configuration system is now production-ready with:
- ✅ All configuration options available
- ✅ Template validation preventing errors
- ✅ Path preview helping users understand output
- ✅ User-friendly error messages

Ready for Phase 4 (File Organization Engine).
</output>
