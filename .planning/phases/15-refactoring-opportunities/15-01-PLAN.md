---
phase: 15-refactoring-opportunities
plan: 01
type: execute
---

<objective>
Address critical error handling technical debt by fixing errcheck violations and improving error handling patterns throughout the codebase.

Purpose: Improve reliability and debuggability by ensuring all errors are properly handled, logged, or explicitly documented as safe to ignore.
Output: Zero errcheck violations, proper error handling for defer Close() calls and critical I/O operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md

**Tech stack available:** Go 1.24, golangci-lint
**Established patterns:**
- Error wrapping with fmt.Errorf("context: %w", err)
- Logging errors with log.Printf() when cannot return
- Interface-based design for testability

**Constraining decisions:**
- Phase 14-02: Pre-commit hooks run golangci-lint with govet, staticcheck, unused, misspell, goimports (errcheck was deferred)
- Phase 14-01: golangci-lint configuration established with pragmatic ruleset

**Issues being addressed:**
- STATE.md Technical Debt: "errcheck violations: 31 defer Close() errors need refactoring (phase 15 target)"
- CONCERNS.md Known Bugs: "Ignored I/O errors in HTTP response handling"
- CONCERNS.md Known Bugs: "Context misuse in background organization"
- CONCERNS.md Known Bugs: "Cookie jar initialization error ignored"

**Current errcheck violations:** ~74 total violations need fixing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix defer Close() error handling</name>
  <files>
    internal/downloads/organization.go,
    internal/persistence/sqlite/config.go,
    internal/persistence/sqlite/downloads.go,
    internal/persistence/sqlite/downloads_test.go,
    internal/qbittorrent/client.go
  </files>
  <action>
Fix all defer Close() calls to properly handle errors. Use named return pattern where appropriate to capture and handle close errors, or add explicit close error checking before defer if the error is critical. For file operations (sourceFile.Close(), destFile.Close()), create helper function `closeWithError` that logs close errors. For database rows (rows.Close()), check error in defer with inline function: `defer func() { if err := rows.Close(); err != nil { log.Printf(...) } }()`. For HTTP response bodies in qbittorrent client, check close errors in defer since they may indicate network issues. Do NOT use `_ = x.Close()` pattern as it's just hiding the error - either handle it properly or add a comment explaining why it's safe to ignore.
  </action>
  <verify>
golangci-lint run --no-config -E errcheck | grep -c "Close.*is not checked" returns 0
  </verify>
  <done>All defer Close() calls either handle errors properly or have documented rationale for ignoring</done>
</task>

<task type="auto">
  <name>Task 2: Fix ignored I/O errors in HTTP handling</name>
  <files>
    internal/qbittorrent/client.go,
    internal/search/providers/mam.go
  </files>
  <action>
Fix all ignored io.ReadAll() errors. In qbittorrent/client.go lines 57 and 144, change `body, _ := io.ReadAll(resp.Body)` to check the error and return it wrapped with context. In mam.go line 140, the io.ReadAll() error in the error handler should be checked - if reading error response body fails, log it but still return the original HTTP error. Pattern: `body, err := io.ReadAll(resp.Body); if err != nil { return fmt.Errorf("failed to read response: %w", err) }`.
  </action>
  <verify>
golangci-lint run --no-config -E errcheck | grep -c "io.ReadAll.*is not checked" returns 0
  </verify>
  <done>All io.ReadAll() calls check and handle errors, no ignored return values</done>
</task>

<task type="auto">
  <name>Task 3: Fix remaining errcheck violations and enable errcheck in CI</name>
  <files>
    internal/downloads/monitor.go,
    internal/downloads/monitor_test.go,
    internal/qbittorrent/client.go,
    .golangci.yml
  </files>
  <action>
Fix remaining errcheck violations: (1) In monitor.go lines 170-171 and monitor_test.go lines 306-307, UpdateError/UpdateStatus calls in error paths - wrap in log statement since we're already handling an error: `if err := m.downloadRepo.UpdateError(...); err != nil { log.Printf("failed to update download error: %v", err) }`. (2) In monitor_test.go line 327, check fmt.Sscanf error or replace with strconv.Atoi for clearer error handling. (3) In qbittorrent/client.go cookiejar.New() error (line 23) - check and return initialization error. After all fixes, update .golangci.yml to add errcheck to the linters.enable list so it runs in pre-commit hooks and CI going forward.
  </action>
  <verify>
golangci-lint run -E errcheck returns exit code 0 (no violations)
  </verify>
  <done>Zero errcheck violations, errcheck enabled in .golangci.yml linters list</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `golangci-lint run -E errcheck` passes with zero violations
- [ ] All tests still pass: `make test`
- [ ] No new warnings introduced
- [ ] .golangci.yml includes errcheck in enabled linters
</verification>

<success_criteria>

- All tasks completed
- Zero errcheck violations remain
- errcheck linter enabled in CI configuration
- All existing tests pass
- Error handling patterns documented in code comments where non-obvious
  </success_criteria>

<output>
After completion, create `.planning/phases/15-refactoring-opportunities/15-01-SUMMARY.md`:

# Phase 15 Plan 1: Error Handling Cleanup Summary

**[One-liner describing what was fixed]**

## Accomplishments

- Fixed all defer Close() error handling (~40+ violations)
- Fixed ignored I/O errors in HTTP response handling
- Fixed update error handling in monitor
- Enabled errcheck linter in CI configuration

## Files Created/Modified

- `[List files with brief descriptions]`

## Decisions Made

[Document any patterns chosen for error handling, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 15-02-PLAN.md (code quality improvements)
</output>
