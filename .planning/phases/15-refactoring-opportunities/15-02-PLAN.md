---
phase: 15-refactoring-opportunities
plan: 02
type: execute
---

<objective>
Address code quality issues and refactor duplicate/fragile code patterns identified in the codebase audit.

Purpose: Improve maintainability by consolidating duplicate logic, fixing context misuse, and extracting reusable utilities.
Output: Cleaner codebase with consolidated filtering logic, proper context propagation, and reduced duplication.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/ARCHITECTURE.md
@.planning/phases/15-refactoring-opportunities/15-01-SUMMARY.md

**Tech stack available:** Go 1.24, React 19, TypeScript, Zustand
**Established patterns:**
- Frontend: State management in Zustand stores, business logic in stores not components
- Backend: Context propagation through function parameters
- Testing: Interface-based mocking, test utilities in testutil package

**Constraining decisions:**
- Phase 12-01: Test helpers and fixtures established for maintainable tests
- Phase 10-01: Architecture decisions documented, contribution guidelines created

**Issues being addressed:**
- CONCERNS.md Tech Debt: "Duplicate filter logic in both store and component"
- CONCERNS.md Known Bugs: "Context misuse in background organization (monitor.go line 96)"
- CONCERNS.md Fragile Areas: "Monitor goroutine context handling needs proper parent context"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Consolidate duplicate search filtering logic</name>
  <files>
    frontend/src/stores/useSearchStore.ts,
    frontend/src/pages/SearchPage.tsx
  </files>
  <action>
Remove duplicate filtering logic from SearchPage.tsx (lines 18-41) and rely entirely on the store's existing filtering (useSearchStore.ts lines 80-106). The store already filters by groupByAuthor and groupBySeries - the component should use the filteredResults from store directly without re-implementing the same filtering. Update SearchPage to: (1) Remove local filtering state and logic, (2) Use `searchStore.results` directly (which is already filtered), (3) Remove redundant filtering function. This consolidates filtering in one place (the store) following established Zustand patterns where business logic lives in stores.
  </action>
  <verify>
npm run build succeeds, search filtering still works correctly (test manually or verify store tests pass)
  </verify>
  <done>Filtering logic exists only in useSearchStore, SearchPage uses store results directly</done>
</task>

<task type="auto">
  <name>Task 2: Fix context misuse in monitor organization</name>
  <files>
    internal/downloads/monitor.go
  </files>
  <action>
Fix context.Background() usage in monitor.go line 96. The organizeDownload() call spawns a goroutine with context.Background() which doesn't respect monitor cancellation. Change to pass monitorCtx instead: `go func(dl models.Download) { organizeDownload(monitorCtx, ...) }(dl)`. This ensures organization goroutines are cancelled when the monitor stops, preventing delayed shutdowns. The 5-minute context timeout is already set in organization.go, so using the parent context doesn't break the timeout behavior. Add comment explaining context propagation pattern for future maintainers.
  </action>
  <verify>
make test passes, monitor tests verify context cancellation behavior
  </verify>
  <done>organizeDownload uses parent context, organization respects monitor cancellation</done>
</task>

<task type="auto">
  <name>Task 3: Extract reusable path sanitization utility</name>
  <files>
    internal/fileutil/sanitize.go,
    internal/fileutil/sanitize_test.go,
    internal/downloads/organization.go
  </files>
  <action>
Create new file internal/fileutil/sanitize.go to house path sanitization utilities. Move SanitizePath function from organization.go to sanitize.go as a public function. Add additional helper SanitizeFilename (similar but specifically for filenames, not full paths). Create sanitize_test.go with test cases for edge cases (empty strings, special characters, path traversal attempts, unicode). Update organization.go to import and use fileutil.SanitizePath. This extracts reusable path handling logic into the utilities package where it logically belongs, making it more discoverable and testable.
  </action>
  <verify>
make test passes, path sanitization tests cover edge cases, organization still works
  </verify>
  <done>Path sanitization in dedicated fileutil package with comprehensive tests</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds (frontend)
- [ ] `make test` passes (backend)
- [ ] No regression in search filtering behavior
- [ ] Monitor shutdown behavior improved (respects context cancellation)
- [ ] Path sanitization utilities properly tested
</verification>

<success_criteria>

- All tasks completed
- No duplicate filtering logic remains
- Context properly propagated through monitor
- Path utilities extracted and tested
- All existing tests pass
- Code quality improved without behavior changes
  </success_criteria>

<output>
After completion, create `.planning/phases/15-refactoring-opportunities/15-02-SUMMARY.md`:

# Phase 15 Plan 2: Code Quality Improvements Summary

**[One-liner describing refactoring improvements]**

## Accomplishments

- Consolidated search filtering logic in store only
- Fixed context propagation in monitor organization
- Extracted path sanitization utilities to fileutil package

## Files Created/Modified

- `[List files with brief descriptions]`

## Decisions Made

[Document any patterns chosen for refactoring, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 15 complete. All v1.2 milestone phases complete - ready for milestone completion or next milestone planning.
</output>
