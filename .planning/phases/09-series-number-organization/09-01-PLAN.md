---
phase: 09-series-number-organization
plan: 01
type: execute
---

<objective>
Add SeriesNumber field to Download model and update API to accept and store series numbers.

Purpose: Enable backend to track series numbers from MAM search results for use in folder organization templates.
Output: Download model with SeriesNumber field, database migration, updated API endpoints accepting series_number.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant prior work
@.planning/phases/03-configuration-system/03-01-SUMMARY.md
@.planning/phases/07-mam-series-detection/07-01-SUMMARY.md

# Key source files
@backend/internal/models/download.go
@backend/internal/models/search.go
@backend/internal/persistence/sqlite/downloads.go
@backend/internal/server/request_types.go
@backend/internal/server/handlers.go

**Tech stack available:**
- Go backend with SQLite persistence
- Repository pattern with interface-based dependency injection
- Chi router for HTTP handlers
- Structured series data (SeriesInfo with ID, Name, Number)

**Established patterns:**
- Add new fields to Download model
- Create database migrations for schema changes
- Update request DTOs and handlers together
- Test-driven validation

**Constraining decisions:**
- Series data structured as []SeriesInfo array (Phase 7)
- Series Number stored as string to accommodate various formats (Phase 7)
- Empty series array instead of null for consistency (Phase 7)

**Context:**
Currently, SearchResult has structured series data with []SeriesInfo (ID, Name, Number), but Download model only stores Series (name) as a string. When users download an audiobook from a series, the series number is lost. This phase adds SeriesNumber field to Download so the organization engine can use {series_number} in templates like "{author}/{series}/{series_number} - {title}".
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SeriesNumber field to Download model and database</name>
  <files>backend/internal/models/download.go, backend/internal/persistence/sqlite/downloads.go, backend/internal/persistence/sqlite/downloads_test.go</files>
  <action>
    Add `SeriesNumber string` field to Download struct in models/download.go.

    Update downloads.go:
    - Add series_number column to CREATE TABLE statement in initSchema()
    - Update INSERT statement in Create() to include series_number
    - Update SELECT statements in GetByID() and List() to include series_number
    - Update row.Scan() calls to include &download.SeriesNumber

    Database migration: Since this is a new column, add migration logic:
    - Check if series_number column exists using PRAGMA table_info(downloads)
    - If missing, run ALTER TABLE downloads ADD COLUMN series_number TEXT DEFAULT ''
    - Run migration on startup before initSchema() to handle existing databases

    Update downloads_test.go:
    - Add SeriesNumber: "1" to test Download fixtures
    - Verify series_number is persisted and retrieved correctly
  </action>
  <verify>go test ./internal/persistence/sqlite -v passes with series_number tests</verify>
  <done>SeriesNumber field added, database schema updated with migration, all persistence tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Update CreateDownload API to accept and store series_number</name>
  <files>backend/internal/server/request_types.go, backend/internal/server/handlers.go, backend/internal/server/dto.go</files>
  <action>
    Update request_types.go:
    - Add SeriesNumber string `json:"series_number,omitempty"` to CreateDownloadRequest struct
    - Add SeriesNumber to BatchCreateDownloadRequest (inherits from CreateDownloadRequest array)

    Update handlers.go in handleCreateDownload():
    - Extract req.SeriesNumber from request
    - Set download.SeriesNumber = req.SeriesNumber when creating models.Download

    Update dto.go:
    - Add SeriesNumber string `json:"series_number,omitempty"` to downloadDTO struct
    - Update toDownloadDTO() to include SeriesNumber: d.SeriesNumber

    No validation needed - SeriesNumber is optional (empty string is valid for books without series or series without numbers).

    Why this approach: Series number comes from frontend (extracted from SeriesInfo.Number during download creation). Backend stores it as-is for later use in organization templates.
  </action>
  <verify>curl -X POST localhost:8080/api/downloads -H "Content-Type: application/json" -d '{"title":"Test","author":"Author","series":"Series","series_number":"1","magnet_link":"magnet:?xt=test"}' returns 200 with series_number in response</verify>
  <done>CreateDownloadRequest accepts series_number, handlers store it in Download model, API response includes series_number field</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test ./internal/persistence/sqlite passes
- [ ] go test ./internal/server passes
- [ ] go build ./cmd/api succeeds without errors
- [ ] Manual API test with series_number shows field persisted and returned
</verification>

<success_criteria>

- SeriesNumber field added to Download model
- Database migration handles existing databases
- All persistence tests pass
- API accepts series_number in CreateDownloadRequest
- API returns series_number in download responses
- No build errors or test failures
</success_criteria>

<output>
After completion, create `.planning/phases/09-series-number-organization/09-01-SUMMARY.md`:

# Phase 9 Plan 1: Backend Data Model Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- SeriesNumber field added to Download model
- Database migration for series_number column
- API updated to accept and return series_number

## Files Created/Modified

- `backend/internal/models/download.go` - Added SeriesNumber field
- `backend/internal/persistence/sqlite/downloads.go` - Schema migration and CRUD updates
- `backend/internal/persistence/sqlite/downloads_test.go` - Added series_number test coverage
- `backend/internal/server/request_types.go` - Added SeriesNumber to CreateDownloadRequest
- `backend/internal/server/handlers.go` - Extract and store series_number
- `backend/internal/server/dto.go` - Added SeriesNumber to downloadDTO

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 09-02-PLAN.md (Template and Organization)
</output>
