---
phase: 09-series-number-organization
plan: 02
type: execute
---

<objective>
Add {series_number} template variable support to template system and organization logic.

Purpose: Enable users to include series numbers in folder organization templates (e.g., "{author}/{series}/{series_number} - {title}").
Output: Template validation supports {series_number}, organization service uses SeriesNumber field, path preview includes series_number.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant prior work
@.planning/phases/03-configuration-system/03-01-SUMMARY.md
@.planning/phases/04-file-organization-engine/04-01-SUMMARY.md
@.planning/phases/09-series-number-organization/09-01-SUMMARY.md

# Key source files
@backend/internal/fileutil/template.go
@backend/internal/fileutil/template_test.go
@backend/internal/downloads/organization.go
@backend/internal/downloads/organization_test.go
@backend/internal/server/handlers.go
@backend/internal/server/request_types.go

**Tech stack available:**
- Template validation with regex placeholder extraction (Phase 3)
- Organization service with interface-based testing (Phase 4)
- Real-time path preview with debounced API calls (Phase 3)

**Established patterns:**
- ValidateTemplate checks placeholders against allowed list
- ParseTemplate replaces {key} with sanitized values
- Sanitize variables BEFORE template parsing (preserves directory structure)
- 500ms debounce for preview API calls

**Constraining decisions:**
- Template validation prevents invalid placeholders (Phase 3)
- Sanitize individual variables before template parsing (Phase 3)
- SeriesNumber stored as string, can be empty (Phase 9 Plan 1)

**Context:**
Plan 1 added SeriesNumber field to Download model. Now we enable the template system to use it. The allowed variables list needs {series_number}, organization logic needs to include it in sanitized vars, and the preview endpoint needs to accept it for real-time template testing.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add series_number to template validation</name>
  <files>backend/internal/fileutil/template.go, backend/internal/fileutil/template_test.go</files>
  <action>
    No changes to template.go needed - ValidateTemplate already accepts allowedVars parameter.

    The allowed variables list is defined in the calling code (server handlers), not in template.go. This task is about ensuring the template system is ready, which it already is.

    Update template_test.go to add test cases demonstrating {series_number} validation:
    - Valid template: "{author}/{series}/{series_number} - {title}"
    - Invalid template: "{author}/{invalid}/{series_number}"
    - Template with series_number only: "{series_number}"

    Add 3 test cases to existing TestValidateTemplate to document series_number support.
  </action>
  <verify>go test ./internal/fileutil -v passes with new series_number test cases</verify>
  <done>Template validation test coverage includes series_number variable, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Update organization logic to use series_number in templates</name>
  <files>backend/internal/downloads/organization.go, backend/internal/downloads/organization_test.go</files>
  <action>
    Update organization.go in Organize() function (around line 73-78):
    - Add "series_number": fileutil.SanitizePath(dl.SeriesNumber) to sanitizedVars map
    - This makes {series_number} available in both template and noSeriesTemplate

    Template examples that now work:
    - "{author}/{series}/{series_number} - {title}" → "Author/Series/1 - Book"
    - "{author}/{title} ({series} #{series_number})" → "Author/Book (Series #1)"
    - "{series_number}. {title}" → "1. Book"

    If SeriesNumber is empty string, {series_number} will be replaced with empty string (cleaned up by path sanitization).

    Update organization_test.go:
    - Add test case TestOrganize_WithSeriesNumber: template "{author}/{series}/{series_number} - {title}" should produce "Author/Series/1 - Book.m4b"
    - Add test case TestOrganize_EmptySeriesNumber: template "{series_number}" with empty SeriesNumber should produce "" (which is fine - folder collapses)
    - Update existing test fixtures to include SeriesNumber: "1" for consistency

    Why this approach: Sanitize series_number like other variables to ensure filesystem-safe values while preserving directory separators in the template.
  </action>
  <verify>go test ./internal/downloads -v passes, series_number appears in organized paths correctly</verify>
  <done>Organization service includes series_number in template vars, tests verify correct path generation with series numbers</done>
</task>

<task type="auto">
  <name>Task 3: Update path preview endpoint to support series_number</name>
  <files>backend/internal/server/handlers.go, backend/internal/server/request_types.go</files>
  <action>
    Update request_types.go:
    - Add SeriesNumber string `json:"series_number,omitempty"` to PreviewPathRequest struct

    Update handlers.go in handlePreviewPath() (around line 350-380):
    - Add "series_number" to allowedVars slice (currently has "author", "series", "title")
    - Add "series_number": fileutil.SanitizePath(req.SeriesNumber) to sanitizedVars map used in ParseTemplate

    Now users can test templates like:
    - "{author}/{series}/{series_number} - {title}" and see live preview: "Example Author/Example Series/1 - Example Book Title"

    Frontend will send series_number from form input (to be added in Plan 3), backend validates and previews it.

    Why add to allowedVars here: The preview endpoint has its own validation logic (doesn't rely on organization service's template). It needs to know series_number is valid.
  </action>
  <verify>curl -X POST localhost:8080/api/config/preview-path -H "Content-Type: application/json" -d '{"template":"{author}/{series}/{series_number} - {title}","author":"Author","series":"Series","series_number":"1","title":"Book"}' returns valid:true with path "Author/Series/1 - Book"</verify>
  <done>Preview endpoint accepts series_number, validates templates with {series_number}, returns preview with series number in path</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] go test ./internal/fileutil passes
- [ ] go test ./internal/downloads passes
- [ ] go test ./internal/server passes
- [ ] go build ./cmd/api succeeds
- [ ] Manual preview API test with series_number shows correct path
</verification>

<success_criteria>

- Template system ready for {series_number} variable
- Organization service includes series_number in template vars
- Preview endpoint validates and uses series_number
- All tests pass including new series_number test cases
- No build errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-series-number-organization/09-02-SUMMARY.md`:

# Phase 9 Plan 2: Template and Organization Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- Template validation supports {series_number} variable
- Organization logic includes series_number in folder paths
- Path preview endpoint accepts and displays series_number

## Files Created/Modified

- `backend/internal/fileutil/template_test.go` - Added series_number test cases
- `backend/internal/downloads/organization.go` - Added series_number to sanitized vars
- `backend/internal/downloads/organization_test.go` - Added series_number test coverage
- `backend/internal/server/handlers.go` - Added series_number to preview endpoint
- `backend/internal/server/request_types.go` - Added SeriesNumber to PreviewPathRequest

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 09-03-PLAN.md (Frontend Integration)
</output>
