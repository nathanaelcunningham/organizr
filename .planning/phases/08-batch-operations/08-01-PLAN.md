---
phase: 08-batch-operations
plan: 01
type: execute
---

<objective>
Create backend batch download endpoint that accepts multiple torrents simultaneously and handles partial success scenarios.

Purpose: Enable users to queue multiple audiobook downloads at once instead of clicking download repeatedly.
Output: Working `/api/downloads/batch` endpoint that processes arrays of download requests and returns detailed results.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior summaries
@.planning/phases/07-mam-series-detection/07-01-SUMMARY.md
@.planning/phases/07-mam-series-detection/07-02-SUMMARY.md

# Key files
@backend/internal/server/handlers.go
@backend/internal/server/request_types.go
@backend/internal/server/routes.go
@backend/internal/downloads/service.go

**Tech stack available:** Go Chi router, SQLite persistence, qBittorrent client with retry logic
**Established patterns:**
- Handler → Service → Repository layered architecture
- Interface-based dependency injection
- Structured error responses with user-friendly messages
- Deferred cleanup for resources

**Constraining decisions:**
- Phase 1: MAM authenticated downloads use torrent file download before qBittorrent upload
- Phase 2: Retry strategy with max 3 attempts for torrent info queries
- Phase 7: Series field is optional string (names only, not numbers)

**Issues being addressed:** None - this is a planned enhancement
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create batch download request/response types</name>
  <files>backend/internal/server/request_types.go</files>
  <action>Add BatchCreateDownloadRequest struct with Downloads field ([]CreateDownloadRequest). Add BatchCreateDownloadResponse struct with Successful field ([]downloadDTO), Failed field ([]BatchDownloadError with Index, Request, and Error fields). This structure allows partial success - some downloads may succeed while others fail due to validation or qBittorrent errors.</action>
  <verify>go build backend/cmd/api completes without errors</verify>
  <done>New types compile, follow existing naming conventions (PascalCase)</done>
</task>

<task type="auto">
  <name>Task 2: Create batch download handler</name>
  <files>backend/internal/server/handlers.go, backend/internal/server/routes.go</files>
  <action>Add handleBatchCreateDownload handler that decodes BatchCreateDownloadRequest, validates array not empty and not too large (limit 50 downloads to prevent abuse), loops over Downloads calling CreateDownload for each. Collect successful downloads in successful slice and failures in failed slice with index and error. Return BatchCreateDownloadResponse with both slices. Add route in routes.go: POST /api/downloads/batch. Use sequential processing (not concurrent) to avoid overwhelming qBittorrent with simultaneous requests. Log batch size and results count.</action>
  <verify>curl -X POST localhost:8080/api/downloads/batch -H "Content-Type: application/json" -d '{"downloads":[{"title":"Test1","author":"Author1","torrent_url":"http://example.com/test1.torrent","category":"Test"},{"title":"Test2","author":"Author2","torrent_url":"http://example.com/test2.torrent","category":"Test"}]}' returns 200 with successful and failed arrays</verify>
  <done>Batch endpoint exists, accepts arrays, processes sequentially, returns structured results with partial success support, enforces 50-item limit</done>
</task>

<task type="auto">
  <name>Task 3: Add batch handler tests</name>
  <files>backend/internal/server/handlers_test.go</files>
  <action>Add TestHandleBatchCreateDownload with subtests: (1) successful batch - all succeed, (2) partial failure - some succeed some fail due to validation, (3) empty array - returns 400, (4) oversized batch (>50 items) - returns 400, (5) all fail - returns 200 with empty successful array. Use table-driven tests following existing test patterns. Mock downloadService.CreateDownload to control success/failure per request.</action>
  <verify>go test ./backend/internal/server -v -run TestHandleBatchCreateDownload passes all subtests</verify>
  <done>Tests pass, cover success/partial/failure scenarios, follow project test conventions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build backend/cmd/api` succeeds without errors
- [ ] `go test ./backend/internal/server -v` passes all tests including new batch tests
- [ ] Batch endpoint exists in routes and handlers
- [ ] Response includes both successful and failed arrays for partial success handling
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript/Go compilation errors
- Batch endpoint handles arrays up to 50 items
- Partial success supported - some downloads can fail while others succeed
- Tests demonstrate batch behavior including edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/08-batch-operations/08-01-SUMMARY.md`:

# Phase 8 Plan 1: Backend Batch Endpoint Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- Created batch request/response types with partial success support
- Implemented batch download handler processing arrays sequentially
- Added comprehensive tests for success, partial failure, and edge cases

## Files Created/Modified

- `backend/internal/server/request_types.go` - Batch types
- `backend/internal/server/handlers.go` - Batch handler
- `backend/internal/server/routes.go` - Batch route
- `backend/internal/server/handlers_test.go` - Batch tests

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 08-02-PLAN.md (Frontend multi-select and batch UI)
</output>
