---
phase: 04-file-organization-engine
plan: 01
type: execute
---

<objective>
Validate and enhance the existing file organization implementation with comprehensive testing, error handling, and edge case coverage.

Purpose: Ensure the organization engine reliably moves/copies audiobook files from qBittorrent's save location to the configured destination with proper structure (Author/Series/Book), handling failures gracefully.
Output: Production-ready file organization with tests, edge case handling, and proper error reporting.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-configuration-system/03-01-SUMMARY.md
@.planning/phases/02-download-monitoring/02-01-SUMMARY.md
@backend/internal/downloads/organization.go
@backend/internal/fileutil/template.go
@backend/internal/fileutil/sanitizer.go
@backend/internal/qbittorrent/client.go

**Tech stack available:**
- Go standard library (io, os, filepath)
- Template system with ParseTemplate and validation
- Path sanitization for filesystem safety
- qBittorrent GetTorrentFiles() method
- Configuration service for paths.destination, paths.template, paths.operation

**Established patterns:**
- Repository pattern for data access
- Service layer for business logic
- Error wrapping with fmt.Errorf("context: %w", err)
- Context propagation with derived contexts and timeouts

**Constraining decisions:**
- Phase 2: Context timeout for organization is 5 minutes (allows large file operations)
- Phase 2: Remote path mapping via paths.local_mount config (prepend to qBittorrent paths)
- Phase 3: Template validation sanitizes individual variables (preserves directory structure)
- Phase 3: Templates support {author}, {series}, {title} placeholders
- Existing code: organization.go already implements copy/move logic

**Current state:**
The organization service (`backend/internal/downloads/organization.go`) is already implemented with:
- Template-based path construction
- File copying and moving support
- Remote path mapping (mount point prepending)
- Integration with qBittorrent file API

This phase focuses on **validation, testing, and edge case handling** rather than new implementation.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comprehensive tests for organization service</name>
  <files>backend/internal/downloads/organization_test.go</files>
  <action>
    Create test file with table-driven tests covering:
    - Successful copy operation (with temp directories)
    - Successful move operation (verify source deleted)
    - Template path construction (with series, without series)
    - Path sanitization integration (verify special chars removed)
    - Remote path mapping (mount point prepending)
    - Directory creation (nested paths)
    - Error cases: missing source files, permission errors, invalid paths

    Use t.TempDir() for test isolation. Mock qBittorrent client responses with test fixtures. Follow Go test conventions from conventions.md (table-driven tests, descriptive names).

    DO NOT test the actual qBittorrent API calls - focus on the organization logic (path construction, file operations, error handling).
  </action>
  <verify>go test ./backend/internal/downloads/... -v passes with >80% coverage on organization.go</verify>
  <done>All test cases pass, organization logic validated, edge cases covered</done>
</task>

<task type="auto">
  <name>Task 2: Add pre-organization validation and disk space checking</name>
  <files>backend/internal/downloads/organization.go</files>
  <action>
    Add validation checks at the start of Organize() method BEFORE file operations:

    1. Check source files exist and are readable (return early with descriptive error if missing/inaccessible)
    2. Calculate total size of files to copy
    3. Check available disk space at destination using syscall.Statfs (Unix) or equivalent
    4. Return error if insufficient space (include human-readable sizes: "Need 1.2GB, only 500MB available")
    5. Add logging for organization start: log.Printf("Organizing %d files (%.2f MB) from %s to %s", fileCount, sizeInMB, sourcePath, destPath)

    Use fileutil package for size formatting if helpers exist, otherwise implement simple formatBytes() helper function in organization.go.

    AVOID creating unnecessary abstractions - keep validation inline in Organize() method.
  </action>
  <verify>go build ./backend/... succeeds, tests still pass, manual test with insufficient disk space returns descriptive error</verify>
  <done>Pre-organization validation complete, disk space checked, clear error messages for failures</done>
</task>

<task type="auto">
  <name>Task 3: Improve error handling and partial failure recovery</name>
  <files>backend/internal/downloads/organization.go</files>
  <action>
    Enhance error handling in the file copy/move loop:

    1. Track successfully copied files in a slice (for cleanup on partial failure)
    2. On copy error: log which file failed, clean up partial copies (delete successfully copied files), return wrapped error
    3. On move error: log failure, do NOT clean up (move is atomic per file), return error
    4. Add defer function to handle cleanup on panic during copy operations
    5. Wrap all errors with context: fmt.Errorf("failed to copy file %s (%s -> %s): %w", fileName, srcPath, destPath, err)

    For copy operation: If file 3 of 10 fails, delete files 1-2 from destination and return error (all-or-nothing).
    For move operation: Partial moves are acceptable (already moved files stay moved, rest remain in source).

    CRITICAL: Do not change the overall function signature or external behavior - only improve internal error handling.
  </action>
  <verify>go test ./backend/internal/downloads/... passes, simulated failures trigger cleanup, errors are descriptive</verify>
  <done>Partial failure handling complete, cleanup on copy errors, detailed error messages</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] go test ./backend/internal/downloads/... passes with good coverage
- [ ] go build ./backend/... succeeds without errors
- [ ] Manual test: Create download, let it complete, verify files organized to correct path
- [ ] Manual test: Simulate disk full condition, verify descriptive error returned
- [ ] Review organization.go for proper error handling and logging
</verification>

<success_criteria>

- All tests pass with >80% coverage on organization.go
- Pre-organization validation checks source files and disk space
- Partial failure cleanup works correctly (copy rollback, move partial success)
- Error messages are user-friendly and include context
- No TypeScript errors, no Go build errors
- File organization works end-to-end in manual testing
</success_criteria>

<output>
After completion, create `.planning/phases/04-file-organization-engine/04-01-SUMMARY.md`:

# Phase 4 Plan 1: File Organization Testing and Validation Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[If phase complete: "Phase 4 complete, ready for Phase 5 (Frontend Integration)"]
[Include any concerns or dependencies that Phase 5 should be aware of]
</output>
