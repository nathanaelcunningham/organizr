---
phase: 7.1-fix-series-download-field
plan: 01
type: execute
---

<objective>
Fix download requests to send series name only (not name with number) for correct folder organization.

Purpose: Ensure file organization creates folders like "Discworld/" instead of "Discworld #1/"
Output: Download requests send series as "Discworld" or "Discworld, Wheel of Time" (names only, no numbers)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-mam-series-detection/07-01-SUMMARY.md
@.planning/phases/07-mam-series-detection/07-02-SUMMARY.md
@frontend/src/components/search/SearchResultListItem.tsx
@frontend/src/components/search/SearchResultCard.tsx
@frontend/src/types/search.ts
@frontend/src/types/download.ts

**Issue discovered during Phase 7 testing:**
When clicking download, the series field sent to backend includes the series number (e.g., "Discworld #1" instead of "Discworld"). This causes the organization function to create incorrect folder structures like `Discworld #1/book.m4b` instead of `Discworld/book.m4b`.

**Root cause:**
Both SearchResultListItem.tsx and SearchResultCard.tsx (lines ~27-29) convert the series array to a string using:
```typescript
const seriesString = result.series.map(s => `${s.name} #${s.number}`).join(', ')
```

This concatenates name + number for download requests. However, for folder organization, we need series NAMES only (numbers are for display purposes).

**Key distinction:**
- **Display series** (lines 211, 58): Show "Series: Discworld #1" in UI ✅ KEEP THIS
- **Download series** (lines 27-29): Send "Discworld" to backend ❌ NEEDS FIX

**Tech available:**
- TypeScript with structured SeriesInfo[] type
- React functional components
- Existing download flow via useDownloadStore

**Established patterns:**
- Array.map() for data transformation
- Conditional series handling with `result.series && result.series.length > 0`
- String joining with `.join(', ')` for multiple series
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix series field in SearchResultListItem download handler</name>
  <files>frontend/src/components/search/SearchResultListItem.tsx</files>
  <action>
    Update the handleDownload function (lines 24-47) to change the series string conversion.

    Replace line 29:
    ```typescript
    ? result.series.map(s => `${s.name} #${s.number}`).join(', ')
    ```

    With:
    ```typescript
    ? result.series.map(s => s.name).join(', ')
    ```

    This extracts ONLY the series name, not the number. For example:
    - Single series: "Discworld" (not "Discworld #1")
    - Multiple series: "Discworld, Wheel of Time" (not "Discworld #1, Wheel of Time #2")

    DO NOT change lines 211 or 62 (display logic) - those should still show the series number in the UI.
  </action>
  <verify>npm run build succeeds without TypeScript errors</verify>
  <done>Download handler sends series names only (no numbers) to createDownload</done>
</task>

<task type="auto">
  <name>Task 2: Fix series field in SearchResultCard download handler</name>
  <files>frontend/src/components/search/SearchResultCard.tsx</files>
  <action>
    Update the handleDownload function (lines 22-45) to change the series string conversion.

    Replace line 27:
    ```typescript
    ? result.series.map(s => `${s.name} #${s.number}`).join(', ')
    ```

    With:
    ```typescript
    ? result.series.map(s => s.name).join(', ')
    ```

    This extracts ONLY the series name, not the number. Matches the fix in SearchResultListItem.tsx.

    DO NOT change line 58 (display logic) - that should still show the series number in the UI.
  </action>
  <verify>npm run build succeeds without TypeScript errors</verify>
  <done>Download handler sends series names only (no numbers) to createDownload</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] Both download handlers (list and card) use `.map(s => s.name)` (not `.map(s => \`${s.name} #${s.number}\``)
- [ ] Display logic still shows series with numbers (lines 211 in ListItem, 58 in Card)
- [ ] No TypeScript errors in modified files
</verification>

<success_criteria>

- Both SearchResultListItem.tsx and SearchResultCard.tsx fixed
- Download requests send series as "Discworld" or "Discworld, Wheel of Time" (names only)
- Display logic unchanged (still shows "Series: Discworld #1" in UI)
- Build succeeds without errors
- Ready for Phase 8 (batch operations) without compounding the issue
</success_criteria>

<output>
After completion, create `.planning/phases/7.1-fix-series-download-field/07.1-01-SUMMARY.md`:

# Phase 7.1 Plan 1: Fix Series Download Field Summary

**[One-liner describing what was fixed]**

## Accomplishments

- Fixed SearchResultListItem.tsx download handler to send series names only
- Fixed SearchResultCard.tsx download handler to send series names only
- [Any other accomplishments]

## Files Modified

- `frontend/src/components/search/SearchResultListItem.tsx` - Updated handleDownload to extract series names only
- `frontend/src/components/search/SearchResultCard.tsx` - Updated handleDownload to extract series names only

## Decisions Made

[Any decisions made during implementation, or "None"]

## Issues Encountered

[Any problems and resolutions, or "None"]

## Next Step

Phase complete - ready for Phase 8 (Batch Operations)
</output>
