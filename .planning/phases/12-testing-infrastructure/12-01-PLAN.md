---
phase: 12-testing-infrastructure
plan: 01
type: execute
---

<objective>
Improve testing infrastructure with reusable test helpers, data fixtures, and coverage reporting.

Purpose: Make writing tests easier and faster by providing standardized helpers and fixtures. Establish coverage baselines for tracking test quality over time.
Output: Test helper utilities for both backend and frontend, test data factories, coverage reporting configuration, and updated testing documentation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md
@.planning/codebase/CONVENTIONS.md

# Auto-selected based on dependency graph:
@.planning/phases/11-api-layer-cleanup/11-01-SUMMARY.md
@.planning/phases/06-end-to-end-testing/06-01-SUMMARY.md

# Key files:
@backend/internal/server/handlers_test.go
@frontend/src/stores/useDownloadStore.test.ts
@frontend/vitest.config.ts

**Tech stack available:** Go (standard testing), Vitest (happy-dom), httptest, table-driven tests
**Established patterns:**
- Interface-based mocking for backend services
- Table-driven tests for comprehensive coverage
- Mock services with function injection pattern
- Vitest with happy-dom for frontend tests

**Constraining decisions:**
- Phase 11-01: Typed error helpers established (use in test assertions)
- Phase 06-01: HTTP handler tests focus on request/response layer
- Race detection required for all concurrent code

**Issues being addressed:** None from ISSUES.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend test helpers and fixtures</name>
  <files>backend/internal/testutil/helpers.go, backend/internal/testutil/fixtures.go</files>
  <action>
Create `backend/internal/testutil/` package with two files:

**helpers.go:**
- `AssertNoError(t *testing.T, err error)` - Fail test if error is not nil with clear message
- `AssertError(t *testing.T, err error, msg string)` - Fail test if error is nil, optionally check error message contains substring
- `AssertEqual(t *testing.T, got, want interface{})` - Compare values using deep equality, fail with diff on mismatch
- `AssertJSONEqual(t *testing.T, got, want string)` - Parse and compare JSON, fail with structural diff
- `NewTestContext(timeout time.Duration) context.Context` - Create context with timeout (default 5s if zero)
- `NewTestHTTPRequest(method, path string, body interface{}) *http.Request` - Create httptest request with JSON body marshaling

**fixtures.go:**
- `NewTestDownload(opts ...func(*models.Download)) *models.Download` - Factory for Download models with functional options pattern
- `NewTestSearchResult(opts ...func(*models.SearchResult)) *models.SearchResult` - Factory for SearchResult models
- `NewTestConfig(overrides map[string]string) map[string]string` - Factory for config maps with sensible defaults
- Default values: ID=uuid, Title="Test Download", Status=models.StatusQueued, Progress=0, CreatedAt=time.Now()

Use variadic functional options pattern (not struct overrides) for type safety. Example: `NewTestDownload(WithTitle("Custom"), WithProgress(50))`.
  </action>
  <verify>go test ./internal/testutil passes, no race conditions with go test -race ./internal/testutil</verify>
  <done>Test helpers package exists, all helper functions documented and tested, follows Go testing conventions</done>
</task>

<task type="auto">
  <name>Task 2: Create frontend test utilities and fixtures</name>
  <files>frontend/src/test/helpers.ts, frontend/src/test/fixtures.ts</files>
  <action>
Create test utilities in `frontend/src/test/`:

**helpers.ts:**
- `waitFor(fn: () => boolean, timeout = 1000): Promise<void>` - Poll condition until true or timeout
- `flushPromises(): Promise<void>` - Wait for all pending promises (uses setTimeout(0))
- `mockFetch(responses: Record<string, any>): void` - Mock global fetch with predefined responses by URL pattern
- `resetMocks(): void` - Reset all vi.mock() calls

**fixtures.ts:**
- `createTestDownload(overrides?: Partial<Download>): Download` - Factory with defaults
- `createTestSearchResult(overrides?: Partial<SearchResult>): SearchResult` - Factory with defaults
- `createTestConfig(overrides?: Partial<Config>): Config` - Factory with defaults
- Default values: id="test-id-{uuid}", title="Test Download", status="downloading", progress=50, etc.

Use Partial&lt;T&gt; for type-safe overrides (TypeScript pattern). Export all utilities from `frontend/src/test/index.ts` barrel file for clean imports.

IMPORTANT: Do NOT modify existing setup.ts - these are additions, not replacements.
  </action>
  <verify>npm test passes, helpers can be imported from @/test/helpers and @/test/fixtures in test files</verify>
  <done>Test utilities available, fixtures provide realistic default data, TypeScript types enforce correctness</done>
</task>

<task type="auto">
  <name>Task 3: Add coverage reporting configuration</name>
  <files>frontend/vitest.config.ts, backend/Makefile, .github/workflows/test.yml</files>
  <action>
**Frontend coverage (vitest.config.ts):**
Add coverage configuration to existing config:
```typescript
test: {
  globals: true,
  environment: 'happy-dom',
  setupFiles: './src/test/setup.ts',
  coverage: {
    provider: 'v8',
    reporter: ['text', 'html', 'json-summary'],
    exclude: [
      'node_modules/',
      'src/test/',
      '**/*.test.ts',
      '**/*.test.tsx',
      'src/main.tsx',
      'vite.config.ts'
    ],
    thresholds: {
      lines: 60,
      functions: 60,
      branches: 60,
      statements: 60
    }
  }
}
```

**Backend coverage (Makefile):**
Create Makefile in backend/ directory:
```makefile
.PHONY: test test-coverage test-race

test:
	go test -v ./...

test-coverage:
	go test -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report: coverage.html"

test-race:
	go test -race ./...
```

**CI pipeline (.github/workflows/test.yml):**
Add coverage reporting to existing CI workflow (or create if missing):
- Backend: Run `make test-coverage`, upload coverage.out as artifact
- Frontend: Run `npm run test:coverage`, upload coverage/ directory as artifact
- Add coverage summary comment to PRs (optional, can use codecov or coveralls action)

Use relative paths, do NOT hardcode absolute paths. Check if Makefile exists before creating. If CI workflow exists, only ADD coverage steps, don't replace existing steps.
  </action>
  <verify>make test-coverage generates coverage.html, npm run test:coverage generates coverage/ directory with HTML report, both commands succeed without errors</verify>
  <done>Coverage reports generated for both frontend and backend, thresholds configured (60% baseline), CI workflow includes coverage steps</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `go test ./internal/testutil` passes with no errors
- [ ] `go test -race ./internal/testutil` passes (no race conditions)
- [ ] `npm test` passes with new test utilities
- [ ] `make test-coverage` generates coverage.html
- [ ] `npm run test:coverage` generates coverage report
- [ ] Test helpers are documented and follow project conventions
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Test helpers available and documented in both backend and frontend
- Test fixtures provide realistic defaults with type-safe overrides
- Coverage reporting configured with 60% baseline thresholds
- Makefile provides convenient test commands
- No errors or race conditions introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/12-testing-infrastructure/12-01-SUMMARY.md`:

# Phase 12 Plan 1: Testing Infrastructure Summary

**Test utilities and coverage reporting established for improved test development velocity**

## Accomplishments

- Created backend test helpers package (testutil) with assertion helpers and test context utilities
- Created backend test fixtures with functional options pattern for realistic test data
- Created frontend test utilities with async helpers and mock utilities
- Created frontend test fixtures with TypeScript Partial&lt;T&gt; pattern for type-safe overrides
- Added coverage reporting for both backend (go test -cover) and frontend (Vitest v8 provider)
- Configured 60% coverage thresholds as quality baseline
- Created Makefile for convenient backend test commands
- Updated CI pipeline to include coverage reporting

## Files Created/Modified

**Created:**
- `backend/internal/testutil/helpers.go` - Assertion and context helpers
- `backend/internal/testutil/fixtures.go` - Test data factories with functional options
- `frontend/src/test/helpers.ts` - Async utilities and mock helpers
- `frontend/src/test/fixtures.ts` - Type-safe test data factories
- `frontend/src/test/index.ts` - Barrel exports for clean imports
- `backend/Makefile` - Test, coverage, and race detection commands

**Modified:**
- `frontend/vitest.config.ts` - Added coverage configuration with v8 provider
- `.github/workflows/test.yml` - Added coverage reporting steps (if workflow exists)

## Decisions Made

- 60% coverage threshold chosen as baseline (realistic for current state, can increase over time)
- Functional options pattern for Go fixtures (more idiomatic than struct overrides)
- Partial&lt;T&gt; pattern for TypeScript fixtures (type-safe and familiar to TS developers)
- V8 provider for Vitest coverage (faster than c8, built-in support)
- Makefile for backend convenience (consistent with Go ecosystem norms)

## Issues Encountered

None

## Next Phase Readiness

Phase complete. Ready for Phase 13 (Developer Documentation). Test infrastructure improvements make it easier to document testing patterns and provide examples in developer docs.
</output>
