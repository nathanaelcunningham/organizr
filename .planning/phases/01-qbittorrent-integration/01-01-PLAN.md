---
phase: 01-qbittorrent-integration
plan: 01
type: execute
---

<objective>
Implement torrent file upload and category support in qBittorrent client.

Purpose: The qBittorrent client currently only supports magnet links and URLs. MAM provides torrents as downloaded files (byte slices), and we need to support qBittorrent categories for organization.
Output: Enhanced qBittorrent client that can add torrents from byte data and assign categories.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/INTEGRATIONS.md
@.planning/codebase/ARCHITECTURE.md
@backend/internal/qbittorrent/client.go
@backend/internal/qbittorrent/types.go
@backend/internal/search/providers/mam.go
@backend/internal/downloads/service.go

**Tech stack available:** Go 1.25.3, Chi router, SQLite, cookie-based auth, multipart/form-data
**Established patterns:** Repository pattern, service layer, cookie jar for session management
**Constraining decisions:** None yet - first phase

**Current state:**
- qBittorrent client exists with Login(), AddTorrent() (magnet/URL only), GetTorrentStatus(), etc.
- MAM provider has DownloadTorrent() that returns []byte torrent data
- No category support in AddTorrent()
- AddTorrent() has incomplete hash extraction (line 107)

**Research findings (from Context7):**
- qBittorrent Web API endpoint: POST /api/v2/torrents/add
- Must use multipart/form-data for file uploads
- Fields: torrents (file), category (string), and other optional params
- After successful add, query /api/v2/torrents/info to get hash (API returns "Ok." not hash)
- Category must exist in qBittorrent before assigning to torrents
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multipart torrent file upload support</name>
  <files>backend/internal/qbittorrent/client.go</files>
  <action>
Create new method: AddTorrentFromFile(ctx context.Context, torrentData []byte, category string) (string, error)

Implementation:
1. Authenticate with Login(ctx)
2. Create multipart/form-data request:
   - Add torrent file as "torrents" field with filename "torrent.torrent"
   - Add category as "category" field if non-empty
3. POST to /api/v2/torrents/add
4. Handle response (should be "Ok." on success)
5. Query /api/v2/torrents/info with filter=recently-added or no filter, sorted by added_on DESC
6. Match torrent by checking info hash or use first result if only one recently added
7. Return torrent hash

Error handling:
- If login fails, return authentication error
- If upload returns non-200, parse body for error details
- If torrent list query fails or empty, return "torrent not found" error
- Wrap all errors with context using fmt.Errorf(..., %w, err)

What to avoid and WHY:
- Don't use strings.NewReader with data - won't work for binary data. Use bytes.Buffer.
- Don't set Content-Type header manually - multipart.Writer sets correct boundary.
- Don't try to extract hash from file content - unreliable. Query API instead.
  </action>
  <verify>
1. Read updated client.go
2. Verify AddTorrentFromFile signature: accepts []byte and category string
3. Check multipart form construction uses bytes.Buffer and multipart.Writer
4. Confirm category field added to form
5. Verify hash retrieval queries /api/v2/torrents/info after upload
  </verify>
  <done>AddTorrentFromFile method exists, accepts torrent data as bytes and optional category, returns hash reliably by querying API after upload.</done>
</task>

<task type="auto">
  <name>Task 2: Wire AddTorrentFromFile into download service</name>
  <files>backend/internal/downloads/service.go, backend/internal/models/download.go</files>
  <action>
Update CreateDownload workflow to support torrent file downloads from MAM:

**In download.go model (if Category field doesn't exist):**
Add Category field to Download model: `Category string json:"category"`

**In service.go CreateDownload method:**
1. After validation, check if torrentURL is a MAM URL (contains "/tor/download.php")
2. If MAM URL:
   a. Extract torrent ID from URL query param (tid)
   b. Call MAMProvider.DownloadTorrent(ctx, torrentID) to get []byte
   c. Call qbClient.AddTorrentFromFile(ctx, torrentData, d.Category)
3. If magnet link:
   a. Keep existing AddTorrent(ctx, magnetLink, "") flow
4. Store returned hash in d.QBitHash

Why this approach:
- MAM requires authentication to download torrents, can't pass URL directly to qBittorrent
- Category support enables better qBittorrent organization
- Fallback to magnet links maintains existing functionality

Error handling:
- If torrent download fails, return wrapped error: "failed to download torrent from MAM"
- If AddTorrentFromFile fails, return wrapped error: "failed to add torrent to qBittorrent"

What to avoid and WHY:
- Don't store torrent bytes in database - they're large and single-use
- Don't skip MAM authentication check - qBittorrent can't download authenticated URLs
  </action>
  <verify>
1. Check Download model has Category field
2. Read CreateDownload method
3. Verify MAM URL detection logic
4. Confirm DownloadTorrent called for MAM URLs
5. Confirm AddTorrentFromFile called with category
6. Check magnet link path still works
  </verify>
  <done>Service layer routes MAM torrents through file download + AddTorrentFromFile. Category passed from Download model. Magnet links still use original AddTorrent.</done>
</task>

<task type="auto">
  <name>Task 3: Update HTTP handler to accept category</name>
  <files>backend/internal/server/handlers.go</files>
  <action>
Update handleCreateDownload to accept category in request body.

Changes:
1. Add Category field to request struct (if not already present)
2. Pass category from request to Download model before calling service.CreateDownload
3. Ensure JSON response includes category field

Validation:
- Category is optional (empty string is valid)
- No special validation needed - qBittorrent will handle invalid categories

Example request body:
```json
{
  "title": "Audiobook Title",
  "author": "Author Name",
  "series": "Series Name",
  "torrentUrl": "https://www.myanonamouse.net/tor/download.php?tid=12345",
  "category": "audiobooks"
}
```
  </action>
  <verify>
1. Read handleCreateDownload handler code
2. Check request struct has Category field
3. Confirm category passed to Download model
4. Verify JSON serialization includes category
  </verify>
  <done>API endpoint accepts category parameter and passes it through to qBittorrent via service layer.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] AddTorrentFromFile method exists with correct signature
- [ ] Multipart form data correctly constructed for file uploads
- [ ] Service layer routes MAM downloads through file upload path
- [ ] Category support wired end-to-end (API → Service → qBittorrent)
- [ ] Code builds without errors: `cd backend && go build ./cmd/api`
</verification>

<success_criteria>

- All 3 tasks completed
- AddTorrentFromFile can upload torrent files and assign categories
- Service layer handles MAM torrent downloads correctly
- API accepts category parameter
- No build errors
- Code follows established patterns (error wrapping, context usage)
</success_criteria>

<output>
After completion, create `.planning/phases/01-qbittorrent-integration/01-01-SUMMARY.md`:

# Phase 1 Plan 1: Torrent File Upload and Categories Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- [What was built]
- [Key capabilities added]

## Files Created/Modified

- `backend/internal/qbittorrent/client.go` - Added AddTorrentFromFile method with multipart upload
- `backend/internal/downloads/service.go` - MAM torrent download integration
- `backend/internal/models/download.go` - Added Category field (if added)
- `backend/internal/server/handlers.go` - Category parameter support

## Decisions Made

- MAM URLs trigger torrent file download (authenticated) instead of passing URL to qBittorrent
- Category is optional parameter (empty string valid)
- Hash retrieval via API query after upload (not extracted from file)

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 01-02-PLAN.md (Integration testing and error handling improvements)
</output>
