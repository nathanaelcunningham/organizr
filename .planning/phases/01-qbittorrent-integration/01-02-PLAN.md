---
phase: 01-qbittorrent-integration
plan: 02
type: execute
---

<objective>
Test qBittorrent integration end-to-end and add robust error handling.

Purpose: Verify the complete workflow from MAM search to qBittorrent torrent addition works correctly, and add proper error handling for common failure scenarios.
Output: Verified, production-ready qBittorrent integration with comprehensive error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-qbittorrent-integration/01-01-SUMMARY.md
@backend/internal/qbittorrent/client.go
@backend/internal/downloads/service.go
@backend/internal/server/handlers.go

**Tech stack available:** Go 1.25.3, Chi router, SQLite, MAM provider, qBittorrent client
**Established patterns:** Error wrapping with context, structured error responses
**From previous plan:** AddTorrentFromFile method, MAM file download integration, category support

**Current state:**
- AddTorrentFromFile implemented with multipart upload
- Service layer routes MAM downloads through file upload
- Category support wired through all layers
- Need to verify end-to-end and add error handling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comprehensive error handling to qBittorrent client</name>
  <files>backend/internal/qbittorrent/client.go</files>
  <action>
Improve error handling in AddTorrentFromFile and other methods:

**AddTorrentFromFile improvements:**
1. Check torrentData is not empty before processing (return error if len(torrentData) == 0)
2. Add timeout to multipart upload (30 second context deadline)
3. Parse qBittorrent error responses - API may return non-200 with error details in body
4. Add retry logic for torrent info query (torrent may take 1-2 seconds to appear in list)
5. Return descriptive errors: "torrent data empty", "upload failed: [api error]", "torrent not found after upload"

**Login improvements (if not already present):**
1. Check for specific auth failures (wrong credentials vs network error)
2. Return wrapped errors with clear context

**All methods:**
1. Ensure all io.ReadAll calls check errors (current line 57, 144 ignore errors)
2. Add request logging for debugging (optional, log.Printf before API calls)

Why these improvements:
- Empty data check prevents confusing API errors
- Retry logic handles qBittorrent processing delay
- Detailed errors make troubleshooting easier
- Fixing ignored errors prevents silent failures

What to avoid and WHY:
- Don't retry indefinitely - use max 3 attempts with 500ms delay
- Don't log sensitive data (passwords, cookies) even in debug mode
- Don't panic on errors - return wrapped errors for caller to handle
  </action>
  <verify>
1. Read updated client.go
2. Check empty data validation in AddTorrentFromFile
3. Verify retry logic for torrent info query (max 3 attempts)
4. Confirm io.ReadAll errors no longer ignored
5. Check error messages are descriptive
  </verify>
  <done>qBittorrent client has comprehensive error handling with validation, retries, and descriptive error messages. No ignored errors remain.</done>
</task>

<task type="auto">
  <name>Task 2: Add error handling to download service</name>
  <files>backend/internal/downloads/service.go</files>
  <action>
Improve CreateDownload error handling:

**MAM URL validation:**
1. Validate MAM URL format before attempting download
2. Check for required tid parameter in URL
3. Return clear error if URL invalid: "invalid MAM torrent URL"

**Torrent download error handling:**
1. Catch MAM authentication failures (401/403) - return user-friendly error
2. Catch MAM torrent not found (404) - return "torrent not found on MAM"
3. Catch network errors - wrap with context

**qBittorrent error handling:**
1. Catch authentication failures - return "qBittorrent authentication failed, check settings"
2. Catch connection refused - return "qBittorrent not reachable at [url]"
3. Catch "torrent already exists" error - return existing hash instead of failing

**Database error handling:**
1. Check for unique constraint violations if ID collision
2. Wrap database errors with operation context

Why these improvements:
- Specific error messages help users diagnose configuration issues
- "Already exists" handled gracefully prevents duplicate errors
- URL validation prevents wasted API calls

What to avoid and WHY:
- Don't expose internal error details to API responses - security risk
- Don't retry database operations automatically - may cause duplicates
- Don't swallow errors - always log and return wrapped error
  </action>
  <verify>
1. Read updated service.go
2. Check MAM URL validation logic
3. Verify specific error types caught and wrapped
4. Confirm "already exists" handled gracefully
5. Check all errors logged and returned
  </verify>
  <done>Download service has comprehensive error handling with validation, specific error messages, and graceful handling of common failures.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete qBittorrent integration with error handling</what-built>
  <how-to-verify>
This requires qBittorrent and MAM credentials. To test:

**Prerequisites:**
1. qBittorrent installed and Web UI enabled (see previous plan)
2. MAM account with API key/cookie

**Test scenario:**
```bash
# 1. Start backend
cd backend
go run cmd/api/main.go

# 2. Configure MAM credentials (in another terminal)
# You'll need your MAM mam_id cookie value
curl -X PUT http://localhost:8080/api/config \
  -H "Content-Type: application/json" \
  -d '{"key": "mam.secret", "value": "YOUR_MAM_ID_COOKIE"}'

# 3. Search for audiobook
curl "http://localhost:8080/api/search?q=test&page=1"
# Note: Copy a torrent ID from results

# 4. Download torrent with category
curl -X POST http://localhost:8080/api/downloads \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Test Audiobook",
    "author": "Test Author",
    "torrentUrl": "https://www.myanonamouse.net/tor/download.php?tid=TORRENT_ID",
    "category": "audiobooks"
  }'

# Expected: JSON response with download object, qbit_hash populated
```

**Verification checklist:**
1. Backend starts without errors
2. Search returns results from MAM
3. Download request succeeds (200 response)
4. Response includes qbit_hash field (not empty)
5. Torrent appears in qBittorrent UI with "audiobooks" category
6. Backend logs show no errors

**Error scenario tests (optional but recommended):**
```bash
# Test invalid MAM URL
curl -X POST http://localhost:8080/api/downloads \
  -H "Content-Type: application/json" \
  -d '{"title":"Test","author":"Test","torrentUrl":"invalid"}'
# Expected: 400 error with descriptive message

# Test wrong qBittorrent credentials
# (Temporarily change qBittorrent password in UI)
curl -X POST http://localhost:8080/api/downloads ...
# Expected: 500 error mentioning authentication failure
```

**If MAM credentials not available:** Type "partial" and describe what you tested
**If everything works:** Type "approved"
**If issues found:** Describe the specific error/behavior
  </how-to-verify>
  <resume-signal>Type "approved", "partial", or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Build succeeds: `cd backend && go build ./cmd/api`
- [ ] Error handling added to all client methods
- [ ] Service layer validates and handles errors appropriately
- [ ] Integration tested with real qBittorrent and MAM (or documented for later)
</verification>

<success_criteria>

- All tasks completed
- qBittorrent client has comprehensive error handling
- Download service validates inputs and handles errors gracefully
- Integration verified end-to-end or documented for later testing
- No build errors
- Phase 1 complete: qBittorrent integration ready for Phase 2 (Download Monitoring)
</success_criteria>

<output>
After completion, create `.planning/phases/01-qbittorrent-integration/01-02-SUMMARY.md`:

# Phase 1 Plan 2: Integration Testing and Error Handling Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- [Error handling improvements added]
- [Integration testing results]
- [Any issues discovered and resolved]

## Files Created/Modified

- `backend/internal/qbittorrent/client.go` - Comprehensive error handling
- `backend/internal/downloads/service.go` - Input validation and error handling

## Decisions Made

- Retry strategy: Max 3 attempts with 500ms delay for torrent info query
- "Already exists" error handled gracefully by returning existing hash
- Error messages user-friendly but don't expose internals

## Issues Encountered

[Problems discovered during testing and how they were resolved]

## Next Phase Readiness

**Phase 1 Complete:** qBittorrent integration fully functional
- ✅ Authentication working
- ✅ Torrent file upload from MAM
- ✅ Category support
- ✅ Hash extraction reliable
- ✅ Error handling comprehensive

**Ready for Phase 2:** Download Monitoring
- Background monitoring can now poll qBittorrent for download status
- GetTorrentStatus() method available
- Download database entries have qbit_hash for tracking

**Concerns:** [Any blockers or concerns for next phase, or "None"]
</output>
